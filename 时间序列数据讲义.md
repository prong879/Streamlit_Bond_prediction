# 时间序列数据

[toc]

## 关键术语对照

| 英文原文 | 对应中文 |
| -------- | -------- |
|          |          |



## 主要分析思路

> **速览**
>
> 1. （序列）平稳性检验
> 2. （残差）白噪声检验
> 3. （序列）模型识别 

> **核心思路**：时间序列的分析，就围绕自相关性展开。一是对序列做平稳性检验，二是对残差做白噪声检验。将被解释变量的变动不断拆分为“确定”+“随机”两部分，用自相关预测确定，白噪声描述随机。

**计量经济学** 把生活中的某个问题抽象化变为数学模型，试图利用数学模型进行分析、预测。我们希望预测的是 **被解释变量 $Y_i$** ，由于它尚未发生，因此存在不确定性。我们需要找出 解释变量 $X_i$ 作为 $Y_i$ 发生变动的原因，用 $X_i$ 的变动来解释 被解释变量 $Y_i$ 的变动，所以可以用 $X_i$得到$Y_i$的估计值$\hat{Y_i}$。学习计量经济学时，我们从静态模型（模型只包含当前时间点的变量，没有未来或是历史数据）开始，建立

$$
Y_i=\beta_0+\beta_1X_i+\varepsilon_i
$$
假如是一元线性回归，解释变量只有$X$，被解释变量是$Y$，那么就相当于构建了一个二元一次函数，这是一条直线，直线上的点就是对应的估计值，我们至少需要两个点才能做出这条一次函数的图像，选取的样本点越多，对真实拟合就越高。

然而，生活中的真实情况不会这么完美地正好和我们预测的直线上的点重合，我们需要预测的未来值是不确定的、可能和完美的估计值存在偏差的，也就是说 $Y_i$是存在波动的可4能的。因此我们建立的线性回归模型中的“原因”包含了两个部分：

* 一个是可观测到的解释变量的线性组合；

* 另一个是不可观测的随机误差项 $\varepsilon_i$ 来表示这种随机的波动、误差。

我们可以根据已经观测到的变量的历史值，试图最小化残差平方和$min\sum_{i=1}^{n} (Y_i - \hat{Y_i})^2=min\sum_{i=1}^{n} e_i^2$，用多元函数求极值的方式，令对各个参数的偏导等于零，列出方程组并求解，从而得到估计的解释变量的系数值。这样一来，只要能够知道需要预测的被解释的$Y_i$对应的解释变量的取值，就可以用解释变量的线性组合得到一个理想化的估计的$\hat{Y_i}$。解释变量可以由观测得到，那么一旦估计出了系数值，就可以把观测到的解释变量带入样本回归方程得到回归直线上的估计值： $\hat{Y}=\hat{\beta_0}+\hat{\beta_1 X}$ 。生活中的现象不可能是这样一条完全笔直的直线，由于各种难以观察的影响的存在，实际上要引入随机误差项 $\varepsilon_i$，描述真实状况对理想状态的偏离来表示各自难以观察的因素。而在我们选取的样本中，可以用真实值对拟合值的偏离，也就是残差$u_i=Y_i-\hat{Y_i}$来作为随机误差的估计。

这样一来，被预测的对象理想化的估计值，再加上理想化地预测的随机误差的估计值，那么模型中结果发生的原因中，可观测和不可观测部分都被我们纳入考虑，并且得到准确的估计，所以就能够在很大程度上把理想化的估计值$\hat{Y_i}$ 变得更加准确，能正确反映出$Y_i$的真实情况。

---

$$
\begin{bmatrix}
X_{t}    \\
X_{t-1} \\
X_{t-2} \\
X_{t-3} \\ 
\cdots \\
\end{bmatrix}
$$

$$
Y_i=\beta_0+\beta_1X_1+\varepsilon_i \\
$$

$$
\begin{cases}
Y_t &=& \beta_0 &+& \beta_1X_{1,t} &+& \varepsilon_t \\
Y_{t-1} &=& \beta_0 &+& \beta_1X_{1, t-1}&+&\varepsilon_{t-1} \\
Y_{t-2} &=& \beta_0 &+& \beta_1X_{1, t-2}&+&\varepsilon_{t-2} \\
\vdots& &\vdots&&\vdots&&\vdots&
\end{cases}
$$

上面三个式子，是计量经济学研究的数据的类型，分别是：

* 时间序列数据：同一个个体在不同时间点的统一项数据组成的序列，例如：某同学过去10次考试的历次得分情况组成的分数序列、某一只股票多年的价格序列，我们称之为 **时间序列数据**；
* 截面数据：同一时点的多个个体的多项数据，例如：某次考试全班50人每人语文、数学、英语三门学科的各科分数；
* 面板数据：多个个体的多维度的时间序列数据：例如：全班40人10次考试每人每科的各自得分。例如某十只股票多年的价格 $Y_t$ 和各个影响因素$X_{tj}$，$t$ 是不同时点，$j$ 是不同个体。

金融计量学重点研究的是其中的时间序列数据。**静态模型**我们认为所有的解释变量都来自于外部，并且都是针对当下的数据进行讨论，解释变量对被解释变量的解释作用只发生在当下，不会影响到未来。

时间序列数据中，因为数据一般具有**自相关性**，所以我们试图把自身的历史值也作为解释变量，纳入模型，也就是认为解释变量的解释作用的作用时间不止在当下，而是可以有持续性，或者说被解释变量对解释变量的起到的影响是有记忆的，就像人对一件事情是有记忆的，不会发生了就马上忘记，随时间的推移慢慢淡忘，深刻程度在时间上有近大远小的特点。因此，**时间序列数据实际上拓宽了解释变量的来源**（可能是历史的自己，也可能是历史的自己的预测误差，取决于时间序列的自相关性是如何体现的）。**所以，确定序列的自相关性，决定了我们应该选择什么样的解释变量，从而让时间序列的预测更加准确。**

---

静态模型中，如果参数估计值是线性、无偏、最小方差、甚至一致的，同时残差是零均值、同方差、无自相关的白噪声，那么对被解释变量 $Y_i$ 的拟合是准确的。但是当数据并不完美时，拟合的准确性就会存在问题。在计量拟合引入时间序列的思想，其意义在于：

* 当残差违反了无自相关的假设，我们实际上也可以把残差视为一个可以利用自相关模型预测的时间序列，从而对预测做出修正（自相关模型，如AR、MA、ARMA）。
* 当残差违反了同方差的假设时，我们实际上也可以把残差的方差看作一个可以预测的时间序列，利用其自相关性对方差进行预测，对残差做出修正（条件异方差模型，如ARCH、GARCH）。

---

金融计量学的研究目标是金融数据，例如：某一只股票多年的价格序列，我们称之为 **时间序列数据**；例如某十只股票多年的价格 $Y_i$ 和各个影响因素$X_{ij}$，我们称之为面板数据。这两类数据是金融计量学研究的重点，尤其是利用这两类数据进行未来值 **预测** 是研究的主要目的。

一般来说，能够用于计量分析的金融数据一般：
* 具有一定的 **平稳性**（**均值、方差不随时间变动，因而可以预测**）
* 序列的残差具有 **自相关性**，需要对序列的残差进行自相关性类型的识别，进而选择合适的模型：可能是自回归自相关（AR），也可能是移动平均自相关（MA），也可能是两者都有的ARMA。

> **平稳性**
> 严格意义的平稳性是**强平稳**，意味着联合概率密度函数在每个时间点 $Y_t$ 和时间滞后点 $Y_{t-i}$​ 都相同；
>
> 广泛意义上的平稳性是**弱平稳**，代表：
>
> * $E(Y_t)$ 在所有时间上都是常数，不依赖于 $t$
> * $Cov(Y_{t+h}, Y_t)$ 只依赖于 $h$ ，不依赖于 $t$，也就是存在均值回归的性质（可以有一定程度的波动，但是随后总会有很大概率向均值回归，也即是：突然一下走高会慢慢往下降，突然一下掉低了会慢慢往回升）。

> **误差、残差、回归差、离差**
> **误差*Error***  $\varepsilon$ 又称 **随机扰动项** $u$，衡量模型本身可能包含的错误（总体角度），是随机变量，因此又被叫做噪音。$\varepsilon_i=Y_i-f(X_i)$
> 
> <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312220238062.webp" style="zoom: 67%;" />
> 
> 以下三者存在关系：
>
> * $离差平方和=残差平方和+回归差平方和$
> * 也就是TSS分解 $TSS=RSS+ESS$
> * 拟合优度$R^2=\frac{ESS}{TSS}$，从误差角度看可解释部分ESS占总体TSS的程度，越大说明模型拟合效果越好。$R^2$ 等于1时可以看出就是一条水平直线，所以完全平稳、拟合得非常好的。
>
> **残差*Residual*** $e_i$ ，“残”意味着：是真实值对拟合值的偏离。可以理解为是样本里包含的错误、噪音，也可以认为残差是对误差的估计值。 $e_i=Y_i-\hat{Y}$。我们通过计算，得到的有确定取值的残差，记作 $u_i$ 。因此，在模型没有求解出或者说正在求解过程中，残差暂时是未知的，我们写作 $e_i$ ；求出了残差的具体值时，再进行探究就写作$u_i$。例如：OLS基本假定中，我们用解释变量解出了参数值，得到$\hat{Y_i}$，因此可以用真实值减去拟合值，得到具体的残差，所以探讨参数是否无偏、一致、最小方差时，我们写作$u_i$。残差平方和为RSS(Residual Sum of Squares)。
> **回归差**，是拟合值对平均值的偏离 $\hat{Y_i}-\bar{Y}$。回归差的平方和是ESS(Explained Sum of Squares)。
> **离差*Deviation***，是个体值对总体均值的偏离 $d_i=Y_i-\bar{Y}$ ，可以认为是残差和回归差的总和。离差的平方和是TSS(Total Sum of Squares)

我们先来速通一遍时间序列分析的思路。

如上面举的例子，某个变量的历史值组成的序列就是一个时间序列数据。对于一个时间序列数据，序列形式就是 **某支股票多年的股价** $Y_{2000}$、 $Y_{2001}$ 一直到 $Y_{2023}$ 甚至未来的 $Y_i$。根据股价我们也可以求出收益率$R_i$。总之，我们可以利用时间序列数据的自相关性建立模型，以自回归自相关为例：

$$
Y_t=\hat{\varphi_1}Y_{t-1}+u_t
$$

这个时间序列数据如果要能够实现很好的预测效果，需要满足：
1. **序列具有平稳性**（序列自身平稳或经过差分之后平稳才有可能进行预测）并且**序列具有非随机性**：也就是 **序列是非白噪声的平稳序列**（对收益率序列的白噪声检验，序列如果随机且平稳，就可能是白噪声从而无法进行预测）
2. **残差是白噪声**，所以残差是零均值、同方差、无自相关，没有条件异方差性（也就是ARCH、GARCH效应）这样就代表拟合值和观测值的偏离最小，即使有偏离从总体来看也比较稳定。

> **白噪声的条件**
>
>  白噪声泛指独立同分布的序列，也就是均值为常数、波动率（方差）有限、无自相关的平稳**随机**序列。或者说具有**同均值**、**同方差（有限）**、**无自相关**。最广泛的形式：
>  $$
>  E(\varepsilon_t)=\mu \\
>  Var(\varepsilon_t)=\sigma^2 \\
>  Cov(\varepsilon_t, \varepsilon_s)=0, t \neq s \\
>  $$
>  如果其分布服从正态分布，那么就是正态白噪声（又称高斯白噪声）。如果均值为零、方差为一，就可以称为标准正态白噪声。
>
> 在下面的内容提到的白噪声，**一般默认是均值为0的正态白噪声。**

对于第一点 **序列是非白噪声的平稳序列** ：
* 首先，**初步判断序列是平稳的**，或有没有可能经过差分之后是平稳的。通常而言，先简单判断（例如从**折线图**）数据是否平稳。有的序列可能自身不平稳，但其**差分序列**可能是平稳的。例如选取一段牛市时期的股价数据，我们发现这段数据保持上涨趋势，肯定不符合平稳性的定义；但是，若对股价序列进行一阶差分得到其 $\Delta$ 值，这个差分序列就可能是平稳的。因此，假如序列如果不平稳，那么可以尝试进行差分处理，差分的次数就是阶数 $I$；假如经过 $I$ 阶差分后序列变平稳了，那么就称之为 $I$ 阶单整，可以继续往下进行分析。
* 进一步地确定数据是否平稳，需要**识别序列的自相关性**，即通过分析ACF、PACF函数或图像选择对应的模型。如果得到的结果是 AR(p) ，那么是否平稳需要通过单位根检验来进一步判断；如果得到的是 MA(q) ，那么由模型的自身性质序列一定平稳；如果得到的是 ARMA(p, q) ，需要对其中的AR部分进行判断，即进行**平稳性检验**。检验方法一般是**单位根DF、ADF检验**。
* 通过ACF、PACF的分析，我们还希望能得出这样的结论：虽然序列平稳，但**序列不是白噪声**，即序列具有**非随机性**。不是所有的平稳序列都值得分析。只有那些序列值之间有密切关系的、历史值对未来值有一定影响的序列，对其建模、预测才有价值。反过来说像白噪声这样在均值附近随机振荡的、没有记忆的序列，过去的行为对未来没有任何影响的纯随机的序列来说，当然没有任何预测的意义。因此，如果序列具有 **自相关性** (当期和前几期之间)，这样的数据肯定是**非随机**的

对于第二点 **残差是白噪声**，其意义在于：如果残差是白噪声，说明我们的建模已经很好地反映了数据的特征，拟合是成功的。如何检测残差是白噪声？抓住白噪声的定义——`零均值、同方差、无自相关的平稳纯随机序列`，重点从整个序列的 **自相关性** （整个序列都不存在自相关，所以专门用于白噪声检验）入手，展开白噪声检验。对于整个序列的自相关性，就不能用DW、LM等方法（这些方法是针对当期和前几期的自相关性检验，不适用于白噪声这种整个序列无自相关性的检验），而是应该使用：
* ACF、PACF（如果平稳，那么也可能说明残差是白噪声）
* BP（针对整个序列的自相关检验）
* LB（针对整个序列的自相关检验）

实际研究的顺序一般是：
1. 初步判断序列平稳性
2. 识别序列的自相关性（模型识别）
3. 序列的平稳性检验
4. 残差的白噪声检验（拟合效果）
5. 模型的优化

---

**金融时间序列数据一般具有自相关性**，所以序列的 **自相关性** 是研究的重点。怎么样从自相关性的三个模型中选出最适合我们的数据的模型呢？一般来说就是利用 `PCF、PCAF函数` 判断自相关的类型是AR(p)还是MA(q)或者是ARMA(p, q)，建立序列的线性模型。如果考虑数据的波动性，可以考虑：序列是否存在 **波动集群** 效应，也就是序列的残差是否有条件异方差效应（详见ARCH、GARCH部分），建立波动率模型。

> 波动集群：如果以股票价格的收益率序列为例，收益率的波动集群也可以说是体现于误差项有 **条件异方差性**，形象的体现就是：大波动后跟着大波动，小波动后跟着小波动，突然上升以后会慢慢下降回去，突然下降以后会慢慢上升回来（均值回归）。

假如序列的残差存在异方差性，那么意味着违反了最小二乘回归的**同方差**的假定，就会让OLS预测的失误越攒越多，误差越来越大。为了解决这个问题，ARCH模型假设：序列误差项$\varepsilon$的波动率$\sigma^2$ 是序列误差项这个白噪声的历史值的平方项 **$\varepsilon^2_{t-i}$** 的线性组合，$\varepsilon^2_t$ 存在自回归性，服从AR(p)。这样就可以做出条件异方差的准确估计，从而提高对序列值预测的精度。

> 在实际的研究中，ARCH、GARCH模型通常用于“波动率”预测，例如用于研究金融风险的波动情况。

---

上面是针对单个时间序列数据的分析。而如果从单个时间序列拓展到多个时间序列数据，例如研究对象是多支股票的收益率，我们就不止需要考虑单个序列自身的平稳性，还需要考虑序列之间的关系，关注其线性组合是否平稳，也就是研究是否存在 **协整** 的性质。把这些序列写成矩阵的形式，分析多个序列的线性组合是否平稳：如果线性组合不平稳，我们同样可以尝试进行差分，类似于我们对单支收益率进行差分变换，I阶变换后平稳就成为 `I阶单整` 一样，目的是为了得到平稳的线性组合：

* 假如对多只收益率进行差分之后，各收益率的线性组合是平稳的，说明这些单整序列之间存在 **协整** 的关系，进而可以建立VAR模型等深入研究其自回归性，还可以进一步差分构建`误差修正模型ECM`。
* 而如果多只收益率的线性组合仍然不平稳，说明没有这些序列之间没有协整关系

* 如果不平稳的同时，有比较大的拟合优度 $R^2$ 和比较小的DW值（自相关性），这样就代表虽然看似拟合不错，看起来存在显著线性关系，其实非平稳变量之间 **是伪回归**。伪回归会让我们无法正确判断变量间的关系，即使做出OLS估计，得到的结果也不符合经济意义。

对于线性组合平稳的时间序列数据矩阵，考虑时间序列数据的自回归性，就可以类似于对一个收益率建立AR模型一样，对矩阵建立 `VAR模型` （其实也有VMA模型）。

---


总结起来，对多维数据，同样先研究序列的平稳性（序列间、序列线性组合的平稳性称之为协整），然后识别其自相关的性质，选择合适的模型（通常默认建立VAR，VMA在学术上也是存在的），最后就可以进行参数估计（ **极大似然估计MLF**、**最小二乘估计OLS**）、统计检验（特别是格兰杰因果检验，突出序列间关系，例如第一类：Y和X一元线性回归、第二类：多个X之间的关系。验证某个变量的滞后项是否对另一个或者另几个变量的当期值有影响。如果有，就说明这个变量可以提高其他相关变量的预测能力。实质上就是系数显著性的检验）。

---

本科《计量经济学》中学的实际上大部分是截面数据，且是静态模型。古典假设对于实际的研究来说，条件是比较苛刻的，数据往往不那么完美。而时间序列数据建模考虑到自相关性，以序列的历史值（滞后项）作为解释变量，其意义在于拓宽了解释变量的来源，考虑到了滞后效应，把模型变成动态模型。例如研究房价上涨对生育率的影响，由于房价上涨的作用是持续性、滞后性的，因此建模回归时应当将房价变量的滞后项列入解释变量中。这样一来先前诸多关于静态模型的假设，实际上可以放宽，利用自相关性建立相应的模型反映其动态变化即可。

* 残差有自相关：把残差视为一个需要被预测、可以被预测的被解释变量，利用自相关性建立模型进行预测。
* 残差不同方差：对于条件异方差的情况，把方差视为一个需要被、可以被预测的被解释变量，利用解释变量的自相关性建立模型进行预测。

对于此前的静态模型，同样提供了很好的工具来解决此前违反诸多古典假设导致的难以预测的困难，例如可以将被解释变量的滞后项纳入解释变量一方，或者把解释变量的滞后值也纳入解释变量中，从而提高预测的准确性，解决违反古典假定时的动态变化的问题 

> **计量经济学的模型**
>
> 计量经济学中最基本的模型形式是 $Y_i=\alpha+\beta X_i + \varepsilon_i$，这实际上是一个静态模型，是针对一个确定的时点的截面数据。
>
> 动态模型简单理解就是包含变量的滞后项，也就是认为模型中存在滞后效应。动态模型类型有：
>
> * 自回归模型：无滞后的解释变量 $X_{t-i}$。被解释变量 $Y_i$ 有长期记忆性。
> * 分布滞后模型：无滞后的被解释变量 $Y_{t_i}$ 。解释变量 $X_i$ 对被解释变量 $Y_i$ 有长期影响。
> * 滞后变量模型：包含解释变量和被解释变量的滞后项。两者性质都有。
>
> 简单介绍其中的重点知识：
>
> 1. 自回归模型：被解释变量有长期记忆性。AR(1) 模型实质上可以从三种形式的分布滞后模型变换而来，分别是：Koyck模型、自适应预期模型、局部调整模型。转换的过程在数学上和经济上都具有一定的意义。
>
> 2. 分布滞后模型：解释变量对被解释变量有长期影响。可以反映乘数效应。有限的分布滞后可以用经验加权法转化为一元线性回归，或者用阿尔蒙法转化为线性回归函数。分布滞后模型存在很强的多重共线性，解决办法是利用分布滞后的性质：
>
> * 无限几何分布滞后（等比数列）
>   * NLS：	非线性最小二乘法，令 $Z_t=X_t+\lambda X_{t-1}+\lambda^2 X_{t-2} + \cdots+\lambda^p X_{t-p}$，构造 $Y_t=\alpha+\beta Z_t+u_t$，P的取值要让$\lambda^P$ 足够小从而不会显著影响 $Z_t$ ，$\lambda$ 的取值要让回归方程有最大的 $R^2$，得到的结果代回方程，就是对应的参数估计值。
>   * Koyck变换为AR(1)。引入延迟算子$L$，把滞后项统一，同理求出$Y_{t-1}$ ，求出 $Y_t-\lambda Y_{t-1}$ 就消去了各个解释变量的滞后项，变成 AR(1)。如果新的残差项$u^*_t$符合古典假定，就可以用OLS估计参数的估计值。
> * 可用多项式描述的分布滞后（多项式曲线描述）
>   * 阿尔蒙法，假设每个系数都是阶数的多项式，利用这个多项式的系数去代替原本的系数做出新的回归方程。
>
> 3. 滞后变量模型：可以推导出误差修正模型：对滞后变量模型两边同时减去 $Y_{t-1}$ ，经过化简，原模型的变量就都是差分化的变量，因此具有平稳性，可以避免伪回归。即使变量本身不平整，只要其线性组合出的新序列平整也就是具有协整性，那么此时ECM的随机误差项就具有平稳性，所有差分变量也具有平稳性。


---

总而言之，解决动态问题的核心就在于把存在动态变化的、需要被预测的变量视为被解释变量，利用其自相关性建立相应的模型进行动态的预测（很像套娃，不断重复“不平稳的就用动态模型做预测，直到得出平稳的”结论）。归根结底，都是希望得到两个特点：

* 序列有自相关的平稳序列（模型识别、单位根检验），所以可以用自相关模型预测序列。
* 残差是无自相关的平稳序列（白噪声检验），所以可以用白噪声描述残差。

总的方法都是围绕自相关的有无展开，主要就是：

* 平稳性检验（识别自相关类型，AR的话就进一步做单位根检验）
* 白噪声检验（判断完全无自相关性）

本文为了方便解释这两大方面的知识，按实际操作顺序进行讲解：

1. （序列）平稳性检验
2. （残差）白噪声检验
3. （条件异方差）模型优化

---

## （序列）平稳性检验

> 时间序列的建模通常要求数据具有平稳性。通常而言，如果序列有自相关性，那么数据就有可能是平稳的。而确认数据是否平稳，我们需要根据数据自相关的特点建立合适的模型，因此这一部分的内容实质上是**自相关模型识别**。为了便于学习，本部分的编写思路是：①介绍平稳性②介绍自相关性③详细介绍AR模型、MA模型、ARMA模型。
>
> 根据研究的数据是一个序列or多个序列，平稳性也分为`单整`与`协整`。我们先学习单整，即单个序列的平稳性。协整实际上是多个序列线性组合得出的新序列的平稳性。

### 平稳性
> 稳稳的幸福，就是爱你始终如一，无论狂风骤雨。

严格意义的平稳性是**强平稳**，意味着联合概率密度函数在每个时间点 $Y_t$ 和时间滞后点 $Y_{t-i}$ 都相同，即时间序列${Y_t}$的**任何部分**的联合概率分布在时间平移后保持不变。例如，取任意时间段 $t_1$,$t_2$,…,$t_n$ 和对应的平移 $t_1+h$,$t_2+h$,…,$t_n+h$，它们的联合分布完全相同。

广泛意义上的平稳性是**弱平稳**，又称协方差平稳：

* $Cov(Y_t, Y_{t-h}) = \varphi^h Var(y_t)$，意味着协方差是一个只和间距 $h$ 有关，和时间 $t$ 无关的函数，不随时间变化而变化。个人认为这一点也是自相关的体现。
* $Var(Y_t) = \frac{\sigma^2}{1-\varphi^2}$， 方差是一个常数。
* $E(Y_t)=\frac{\mu}{1-\varphi}$ ，均值是和时间 $t$ 无关的常数，不随时间变化而变化
* 总结起来就是，方差（波动率）是与时间无关的常数，均值是与时间无关的常数，协方差是只与时间的间隔有关、和t无关的常数。

> 对比
>
> | 性质 | 严格平稳                                                  | 弱平稳                                                       |
> | ---- | --------------------------------------------------------- | ------------------------------------------------------------ |
> | 要求 | 所有联合分布不变                                          | 均值、方差、协方差稳定                                       |
> | 条件 | 所有统计性质相同，如所有矩稳定（若存在）                  | 仅需均值（一阶矩）、方差和协方差（二阶矩）稳定               |
> | 例子 | i.i.d.序列、柯西分布序列（均值、方差不存在，但分布相同）  | AR(1)模型，如$Y_t=0.5Y_{t-1}+\varepsilon_t$<br />（系数小于1的AR模型是弱平稳的，但如果加入时变的高阶矩特征，可能会非严格平稳） |
> | 关系 | 严格平稳+二阶矩存在->弱平稳<br />（严格平稳允许矩不存在） | 弱平稳通常不是严格平稳<br />（严格平稳条件难以满足）         |
>
> 

现在我们深入研究时间序列数据的平稳性。首先针对单变量的时间序列进行分析。直观理解平稳性，下面四幅图，可以看出来：

1. 第一幅是白噪声，完全随机，是 平稳序列；
2. 第二幅随机游走，没有固定趋势，均值、方差波动程度较大，是 非平稳序列，具有**随机性**；
3. 第三幅趋势上升，但均值随时间增加而增加，是 非平稳序列；
4. 第四幅曲线大致在一条水平线上下波动，波动程度前后变化较小，均值没有明显随时间变动，可以认为是平稳的。第四幅是第三幅差分后的结果，可以看到像第三幅这样的不平稳序列，实际上也是有可能通过求差分变平稳的。

<img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312220238215.jpeg" style="zoom: 25%;" />

例如：根据美元兑人民币的汇率中间价序列$p_t$，作其对数序列$y_t=ln(p_t)$，并绘制趋势图及进行描述性统计。从数据的折线图（见图1）可看出，对数序列$y_t$存在较明显的时间趋势，可以判断对数序列不平稳。因此对对数序列进行一阶差分，得到一阶对数差分序列$dy_t=y_t-y_{t-1}$。根据一阶对数差分序列折线图（见图1）可初步判断$dy$序列平稳（严格来说，这个例子的一阶差分序列有显著的条件异方差特征，不能严格说平稳。此处仅仅为了展示经过差分后的数据是有变平稳的可能）。

<center class="half">
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/%E5%AF%B9%E6%95%B0%E5%BA%8F%E5%88%97%E6%97%B6%E5%BA%8F%E5%9B%BE.svg" width="300"/>
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/%E4%B8%80%E9%98%B6%E5%AF%B9%E6%95%B0%E5%B7%AE%E5%88%86%E5%BA%8F%E5%88%97%E6%97%B6%E5%BA%8F%E5%9B%BE.svg" width="300"/>
</center>


> **随机游走**
> DF检验的原假设是：$|\varphi|=1$，实际上这就是随机游走的含义：一旦$|\varphi|=1$，说明序列值$Y_t$取决于白噪声$\varepsilon_t$，因此任意的序列值 $y_t=\mu + y_{t-1} +\varepsilon_t$ 都可以表示成历史白噪声的组合 $y_t=\varepsilon_t+\varepsilon_{t-1}+\varepsilon_{t-2}+\cdots+\varepsilon_1$ 所以任意序列值不会超过历史白噪声的总和，序列值就会是完全随机的，如同醉汉摇摇晃晃乱走路（Random Walking），即随机游走。在物理上，**布朗运动**就是一个随机游走过程。随机游走的数据的特点：
>
> * 零均值 $\mu_{Y_t}=0$
> * 方差和t相关 $Var(Y_t) = t \sigma^2$ ，所以数据不平稳
>
> $$
> Var(Y_t) = Var(v_{t})+Var(v_{t-1})+\cdots+Var(v_{1})
> $$
>
> 随机游走序列可表示为历史白噪声的线性组合，因此对这个式子两边同时求方差，不难看出，结论是 $Var(Y_t) = t \sigma^2$ ，意味着方差是随时间变化的函数，不符合协方差平稳的条件。

### 自相关性与ACF、PACF函数

我们说过：**序列自身要平稳且不能是白噪声（没有纯随机性），这样才能用于预测**。如果序列是白噪声序列（完全随机）或者非平稳序列（完全随机），都是不能进一步分析的。因此，时间序列数据的**平稳性**和**非随机性**对预测至关重要。

金融数据一般来说都有 **自相关性**，例如股票的当期价格可能受历史价格影响，也可能受冲击因素也就是噪音的影响。这也是它平稳的原因之一，就像水池今天的水位是受到前一段时间的影响的；另一方面来说，就像在水里丢一块石头，波纹逐渐扩散开，而不是直接全部原地蒸发或者瞬间爆满。这种**自相关性就意味着金融数据可能有一定的平稳性，且数据是非随机的**，短期内会有波动但长期来看可能是平稳的。

针对单个序列，我们需要检验序列自身是否平稳，也就是判断序列是否是 **$I$ 阶单整序列**。由于时间序列往往具有序列相关性（自相关性，当期值和历史值相关），针对不同类型的自相关时间序列，除了通过观察序列值 $Y_t$ 的图像的特征进行大致判断，还需要进行ACF、PACF的计算，从而确定自相关模型的类型，从而确认序列是否具有平稳性。序列自相关可能是像上面说的：

1. 受历史值影响；
2. 受噪音影响。


为了描述自相关性，计量经济学常用**自相关系数ACF**和**偏自相关系数PACF**。ACF是自相关函数，PACF是偏自相关函数，他们的横坐标都是滞后的阶数，纵坐标表示的是自相关、偏自相关的大小。他们各自的作用是：
* ACF反映了存在时滞周期k的两个子序列之间的相关性，因此体现序列动态路径的发展情况
* PACF反映了特定时点之间的相关性（如同偏导的定义一样）因此体现冲击因素的影响情况

我们这个模型为例讲解ACF和PACF的含义

$$
Y_t=\mu + \varphi_1Y_{t-1}+\varphi_2Y_{t-2} + \cdots + \varphi_p Y_{t-p}+\varepsilon_t
$$

> **自相关函数ACF**
> 例如我们有一个 $Y_i$ 序列，ACF的原理可以认为是利用滞后k期的滞后周期，取出两个等长的子序列（例如第一个是$Y_1$到$Y_8$，第二个是$Y_2$到$Y_{10}$，这就是滞后k期的含义），分析他们的相关性，因此ACF反映了存在时滞周期k的两个子序列之间的相关性，实质上**体现的是自己和滞后k期的历史值之间的相关性。**

> **偏自相关函数PACF** 
> 实际上可以这么理解：我们对时间序列模型建立AR(p)自回归模型，此时被解释变量是t时刻序列值 $X_t$，解释变量是其滞后项 $Y_{t-i}$。滞后项的系数 $\varphi_i$ 可以反映解释变量 $Y_{t-i}$ 的变化对被解释变量 $Y_t$ 变化的影响作用，因而 **PACF实质上剔除了中间其他时期的序列值的影响，直接反映了不同时期序列值之间的相关性**。

---

### 自相关模型识别

接下来就是探究序列自相关的形式，确定具体的 **自回归的模型类型(ar、ma、arma)**和**模型阶数 (p、q)**。序列自相关可能是像上面说的：
1. 受历史值影响；
2. 受噪音影响。

判断自相关性关键在于：①是自回归自相关还是移动平均自相关？②自相关的阶数？

根据自相关的特点，时间序列数据的自相关模型主要是以下三种：第一种模型我们称之为**自回归自相关**AR(Auto regress)，即现在的自己受到过去的自己的影响，也就是自回归；第二种模型我们称之为**移动平均自相关**MA(Moving average)，即现在的值受到冲击因素（噪声）的影响。当然也有第三种模型也就是综合起来考虑的**自回归移动平均自相关**ARMA(Auto regress and Moving average)模型。序列自相关性影响的范围就是自回归模型相应的阶数。如果进行深入研究，时间序列的相关研究引入了序列相关性的概念，实质上是计量经济学中研究动态模型的重要基础。

阶数的判断，一般而言是指**在某一阶之后**序列为零，或序列处于置信区间内。实际模型的选择一般需要看AIC、BIC信息准则，选择有最小信息准则的模型。

---

回顾ACF自相关函数与PACF偏自相关函数的知识：
* ACF反映了存在时滞周期k的两个子序列之间的相关性
* PACF反映了特定时点之间的相关性（如同偏导的定义一样）

一般而言，平稳序列的自相关函数ACF、偏自相关函数PACF会**迅速退化**到0，滞后期越短可能越平稳。迅速退化的这种特点，被我们分为截尾和拖尾两种情况：
* **截尾** ：在某一阶之后等于0；
* **拖尾** ：某一阶之后都在区间内徘徊（自相关系数呈现余弦衰减）。

因此假如自相关函数退化比较慢、或者存在剧烈波动、先减后增等情况，也就是意味着较多的相关系数在边界外，自相关函数没有截尾或者拖尾，说明序列不平稳。因此我们需要重点关注ACF、PACF的特点：
* 如果ACF拖尾 PACF截尾，说明序列自相关存在自回归性，应该选用AR自回归自相关模型。AR模型重点考察的就是动态路径的发展状况，比如股价历史值是怎么样动态影响当前值的发展的。
* 如果ACF截尾 PACF拖尾，说明序列自相关存在移动平均性，应该选用MA自回归自相关模型。MA模型重点考察的是某个冲击因素对模型的影响，冲击因素就是我们所说的噪音项
* 假如ACF PACF都拖尾，那么就选用ARMA法，两者兼具。

| 数据自相关类型 |   ACF    |   PACF   | 考查重点 |       平稳性       |
| :------------: | :------: | :------: | :------: | :----------------: |
|    $AR(p)$     | **拖尾** |   截尾   | 动态路径 | 需要进行单位根检验 |
|    $MA(q)$     |   截尾   | **拖尾** | 冲击因素 |      一定平稳      |
|  $ARMA(p, q)$  | **拖尾** | **拖尾** | 二者皆有 |  判断其中的AR部分  |

直接观察ACF、PACF是第一种办法，有的软件还有一种方法叫MTV（min table value）法也即是最小表格值法。它会给你一个表格，表格横轴和纵轴分别是不同阶数的AR MA。表格内部的值表示的是MTV的取值，最接近2的那个模型就是最合适的模型，这就是我们关于模型的识别。



> **数学角度的推导和结论**
> 概率论中，**协方差** 用来衡量两个变量之间的相关程度
> $$
> Var(X)=E\left[ \sum \left[ X-E(X) \right]^2 \right]=\sigma^2
> $$
>
> **协方差** 用来衡量两个变量之间的相关程度
> $$
> Cov(X, Y)&=&E\left[ (X-E(X))(Y-E(Y)) \right]  \\
> &=&E(XY)-E(X)E(Y)
> $$
>
> * 协方差大于0，那么X和Y正相关（说明X和Y总体上看是同向变动）；
> * 协方差小于0，X和Y负相关相关（说明X和Y总体上看是同反变动）；
> * 协方差等于0，两者不相关（没有相关趋势）
>
> 如果在时间序列中求协方差 $Cov(X_t, X_{t-k})$，由于对象是自身 $X_{t}$ 和自身滞后值 $X_{t-k}$ ，因此这样的协方差称之为 **自协方差$\gamma_k$**，有性质：**$\gamma_k=E(X_t X_{t-k})$**
> 
> 由于X和Y的量纲可能存在差异，例如中国的猪肉价格X和美国的猪肉价格Y，一个是用人民币来计价，一个用美元来计价，因此两者变动的幅度不一定相同，这会导致两者的相关性被放大或者被缩小，相关性分析就不准确了。
> 
> 因此，对协方差进行归一化得到 **相关系数**，就可以消除了量纲差异，类似于线性代数里向量的标准化，使不同维度的数据可比，可以准确判断相关性。
> **相关系数** 是对协方差进行归一化得到的，消除了量纲差异，类似于线性代数里向量的标准化，使不同维度的数据有具体的范围、相同的幅度可比，可以准确判断相关性的强弱，-1是完全负相关，+1是完全正相关，取值范围是：$\rho \in [-1, 1]$。
> $$
> \rho_{X, Y} = \frac{Cov(X, Y)}{\sigma_X\sigma_Y}
> $$
>
> 计量经济学中，对这些工具做了拓展：
> **自协方差**
> 如果在时间序列中求协方差 $Cov(X_t, X_{t-k})$，由于对象是自身 $X_{t}$ 和自身滞后值 $X_{t-k}$ ，因此这样的协方差称之为 **自协方差$\gamma_k$**
> $$
> \gamma_k=Cov(X_t, X_{t-k})=E\left[ (X_{t}-E(X_{t}))((X_{t-k}-E(X_{t-k})) \right]
> $$
> 并且有重要性质：**$\gamma_k=E(X_t X_{t-k})$**
>
> * 有偏估计 $\hat{\gamma_k}=\frac{1}{n} \sum^{n}_{t=k+1}(X_t-\mu)(X_{t-k}-\mu)$ 
> * 无偏估计 $\gamma_k =  \frac{1}{n-k} \sum^{n}_{t=k+1}(X_t-\mu)(X_{t-k}-\mu)$
> * $\hat{\gamma_k}=\frac{n-k}{n}\gamma_k$ , $\gamma_k=\frac{n}{n-k}\hat{\gamma_k}$
>
> **偏自相关系数**
> 实际上就是$X_{t}$和$X_{X_{t-h}}$两个时点间的相关系数，“偏”是借用偏导数的定义，体现“点到点”之间相关性的特点。
> $$
> \varphi_h=\rho_{X_t, X_{t-h}}=\frac{Cov(X_t, X_{t-k})}{\sigma_t\sigma_{t-h}}
> $$
> 在下面的AR(p)模型中，$\rho_{X_t, X_{t-h}}$ 实际上就是滞后k阶项的系数 $\varphi_k$  。
>
> **自相关系数**
> $$
> \rho_k = \frac{Cov(X_t, X_{t-k})}{Cov(X_t, X_t)} = \frac{\gamma_k}{\gamma_0}=\frac{Cov(X_t, X_{t-k})}{\sigma_t^2}
> $$
> 可以看出，实质上反映了滞后h期与当前的相关性。

ACF和PACF反映了相关性的程度、特点，其计算是通过下面的自相关模型参数估计推导出的。


> $$
> \rho = \frac{Cov(X, Y)}{\sigma_X\sigma_Y}
> $$
> 
> **相关系数** 在计量经济学里有两大应用：
> 一是：针对最小二乘回归，我们希望探讨变量之间的相关性，如：**X和Y的相关性**。
> * 在一次回归的模型中，
>   * 当模型是是一元线性回归，我们构建 $\rho_{X, Y} = \frac{Cov(X, Y)}{\sigma_X\sigma_Y}$ 。一元回归的拟合优度实质上在数值上等于相关系数 $\sqrt{R^2}=\rho$ 。
>   * 当模型是多元线性回归，拟合优度和相关系数就不一样，因为拟合优度表示**被解释变量Y能被解释变量X解释的比例** $R^2=\frac{ESS}{TSS}$ ，也就是用来衡量**模型拟合的好坏**，而相关系数只是表示**两个变量间的线性相关性**。
> * 在二次回归的模型中，我们利用OLS得到 $\hat{Y}$ ，并且 $\bar{\hat{Y}} = \bar{Y}$，这两者的相关系数化简后有 $\rho_{\bar{\hat{Y}}, \bar{Y}}=\sqrt{R^2}$，个人理解就是： 拟合优度 等价于 被解释变量估计值 和 真实值 从整体角度（求平均）的相关性，整体角度来看估计值的平均水平和真实值的平均水平越接近，模型拟合越好。
> 
> 二是：针对时间序列数据，我们关注序列相关性，这种自相关性也可以用相关系数来衡量，被称之为 **自相关系数ACF(k)** 
> $$\rho_k = \frac{Cov(X_t, X_{t-k})}{Cov(X_t, X_t)} = \frac{\gamma_k}{\gamma_0}=\frac{Cov(X_t, X_{t-k})}{\sigma^2}$$
>
> $\gamma_k$ 是自协方差，协方差和相关系数的关系是$\gamma(k)=E(X_tX_{t-k})$，其估计值有两种：
> * 有偏估计 $\hat{\gamma_k}=\frac{1}{n} \sum^{n}_{t=k+1}(X_t-\mu)(X_{t-k}-\mu)$ 
> * 无偏估计 $\gamma_k =  \frac{1}{n-k} \sum^{n}_{t=k+1}(X_t-\mu)(X_{t-k}-\mu)$
> $\hat{\gamma_k}=\frac{n-k}{n}\gamma_k$，$\gamma_k=\frac{n}{n-k}\hat{\gamma_k}$
> 
> 因此，自相关系数ACF(k) 的估计也包括有偏估计和无偏估计两种：
> * 有偏估计 $\widehat{ACF(k)}=\hat{\rho_k} = \frac{\hat{\gamma_k}}{\hat{\gamma_0}} = \frac{Cov(X_t, X_{t-k})}{Cov(X_t, X_i)} = \frac{n-k}{n}\cdot \frac{\gamma_k}{\gamma_0}$
> * 无偏估计 $ACF(k)=\rho_k=\frac{\gamma_k}{\gamma_0}=\frac{n-k}{n}\cdot \frac{Cov(X_t, X_{t-k})}{Cov(X_t, X_t)}=\frac{n-k}{n}\cdot \frac{\hat{\gamma_k}}{\hat{\gamma_0}} $


---

总结起来，从实际检测的对象和方法的角度而言：
* $AR(p)$ 自回归自相关模型，通过ACF、PACF函数的特征判断数据类型，如果是自回归自相关的数据，需要通过 **DF/ADF单位根检验**，确定其特征方程是否存在单位根，从而判断是否平稳。
* $MA(q)$ 移动平均自相关模型，不论阶数大小，存在移动平均自相关性的数据一定具有平稳性，因此可以通过ACF、PACF函数的特征判断数据类型，确定是$MA(q)$那么数据平稳。
* $ARMA(p,q)$ 关注AR部分，同样的操作。

---

下面进行详细讲解。

### AR模型

AR(p)模型为自回归模型(Autoregressive Model)，利用自身当前数据和其历史数据之间的相关性（自相关）来建立回归方程。如果时间序列$\{Y_t\}$的当前值与其滞后项之间存在线性关系，即可以把$Y_t$表示为其滞后项$Y_{t-i}$的线性组合，公式如下：
$$
Y_t=\mu+\varphi_{1}Y_{t-1}+\varphi_{2}Y_{t-2}+\cdots +\varphi_{p}Y_{t-p} +\varepsilon_t
$$

其中，$\varphi$为自回归系数，$p$为阶数，$\{\varepsilon_t\}$是为白噪声序列，满足零期望$E(\varepsilon_t)=0$，同方差$Var(\varepsilon_t)=\sigma^2$，无自相关性$Cov(\varepsilon_t,\varepsilon_s)=0,t\neq s$。

具体来说，假如我们认为 **当期值是过去值的线性组合加当期白噪声的结果**，意味着 $Y_t$ 和 $Y_t-1$ 自相关也就是 $Y_i$ 具有自相关性，我们就会构建AR模型，也就是意味着我们可以 **用 $Y_i$ 自己的历史值预测自己未来值**，这个历史的范围就是滞后的阶数p。

我们可以把含截距项的 AR(p) 模型转化成 不含截距项的形式。假如 AR(p) 的均值是 $\mu$ ，那么可以对原模型去均值化，得出
$$
Y_t - \mu = a_1(X_{t-1}-\mu)+a_2(X_{t-2}-\mu)+\cdots+a_p(X_{t-p}-\mu)+\varepsilon_t
$$
这样，就可以将含有截距项的模型构造成一个不含截距项的新模型
$$
Y_t=\varphi_{1}Y_{t-1}+\varphi_{2}Y_{t-2}+\cdots +\varphi_{p}Y_{t-p} +\varepsilon_t
$$
由于做了去均值的处理，这个新模型的均值就等于0，是均值为0的AR(p)模型，下文的 Yule-Walker方程就是基于这样的模型建立的。

AR(p) 的高阶自回归模型
$$
Y_t=\mu+\varphi_{1}Y_{t-1}+\varphi_{2}Y_{t-2}+\cdots +\varphi_{p}Y_{t-p} +\varepsilon_t
$$
可以写成向量形式
$$
Y_t =
\begin{matrix}
    \underbrace{[1, Y_{t-1}, Y_{t-2}, \cdots, Y_{t-p}]} \\ X^T_t
\end{matrix}
\begin{matrix}
    \underbrace{\begin{bmatrix}
    \mu       \\
    \varphi_1 \\
    \varphi_2 \\
    \vdots    \\
    \varphi_p \\
\end{bmatrix}} \\ \Phi
\end{matrix} + \varepsilon_t
$$

$$
Y_t=X^T_t\theta + \varepsilon_t
$$

与自回归模型常常联系在一起的是**平稳性问题**，此处暂时只简要介绍，下文会详细说明。引入差分算子$L$，定义$Y_t \cdot L=Y_{t-1}$，则可推导出AR模型的特征方程是

$$
1-\varphi_1 L-\varphi_2 L^2-\cdots \varphi_p L^p=0
$$

如果特征方程所有根的绝对值都大于一，那么AR(p)是一个平稳的随机过程，因此p阶自回归时间序列的平稳性的条件是$|L_i|>1$​。需要注意的是，如果序列数据不满足平稳性，误差项可能对AR模型预测产生很大的影响，因此AR模型适用于平稳时间序列。

---

AR模型的核心知识：

* 平稳性的判断（单位根检验）
* 和自相关系数的联系 （Yule-Walker方程）
* 参数估计的方法
  * Yule-Walker方程 估计
  * 最小二乘估计
  * 极大似然估计


#### AR(p)的单位根检验

上文说过，对于单个时间序列数据，我们可以通过ACF、PACF函数的特征判断数据类型。确定数据的自回归类型后，就可以进行平稳性的判断：
* 若发现数据符合MA(q)，那么数据肯定平稳
* 若发现数据符合AR(p)，那么我们应当通过 **单位根检验** 的方法来确定AR(p)是否平稳。特征方程不存在单位根等价于数据平稳。
* 若发现数据符合ARMA(p, q)，那么需要确定其中的AR(p)部分是否平稳。

单位根检验，对于AR(1)叫DF检验，AR(p)叫ADF检验。

##### DF检验
DF检验（Dickey-Fuller test）是针对 $AR(1)$ 模型进行平稳性分析。正如上面所说，如果确定是 $MA(q)$ ，那么数据必然平稳；如果确定是 $AR(p)$，假设阶数是1，模型是含有截距项和一期滞后项和随机误差项的 $AR(1)$ 模型
$$
Y_t=\mu +\varphi Y_{t-1} +\varepsilon_t
$$

从数学角度，AR(1)是否平稳，主要是根据一阶滞后项的系数$\varphi$的大小来判断。很容易地可以推测：

* $\varphi=1$，前一时刻对后一时刻的影响是100%的，不会减弱，那么可以推断：这种影响和数据起始点（例如我们人为选择一个起点）有关，且当前时点受以往所有时点的影响，因此肯定不平稳。
* $\varphi>1$，这意味着当前时刻的波动不仅受前面时刻的影响，而且还被放大，因此肯定不平稳；
* $\varphi<1$，这意味着当前时刻的波动受前面时刻的影响，但会随时间不断减小，因此是平稳的。

因此，$AR(1)$ 弱平稳（**协方差平稳**）的条件是：

* 随机误差项滞后项$\varepsilon_t$是白噪声
* $y_{t-h}$ 的系数 $\varphi< 1$ 

这等价于：
* $Cov(Y_t, Y_{t-h}) = \varphi^h Var(Y_t)$，意味着协方差是一个只和间距 $h$ 有关，和时间 $t$ 无关的函数，不随时间变化而变化。个人认为这一点也是自相关的体现。
* $Var(Y_t) = \frac{\sigma^2}{1-\varphi^2}$， 方差是一个常数。
* $E(Y_t)=\frac{\mu}{1-\varphi}$ ，均值是和时间 $t$ 无关的常数，不随时间变化而变化

因此，DF检验
* 原假设$H_0$：$\varphi=1$，意味着序列是一个随机游走序列，不平稳
* 备择假设$H_1$：$\varphi<1$，意味着 $AR(1)$ 序列具有弱平稳性（协方差平稳）

> **随机游走**
> DF原假设是：$\varphi=1$，实际上这就是随机游走的含义：一旦$\varphi=1$，说明序列值$Y_t$取决于白噪声$\varepsilon_t$，因此任意的序列值 $$y_t=\mu + y_{t-1} +\varepsilon_t$$ 都可以表示成历史白噪声的组合 $$Y_t=\varepsilon_t+\varepsilon_{t-1}+\varepsilon_{t-2}+\cdots+\varepsilon_1$$ 所以任意序列值不会超过历史白噪声的总和，序列值就会是完全随机的，如同醉汉摇摇晃晃乱走路（Random Walking），即随机游走。随机游走的数据的特点：
>
> * 零均值 $\mu_{Y_t}=0$
> * 方差和t相关 $Var(Y_t) = t \sigma^2$ ，所以数据不平稳
>
> $$
> Var(Y_t) = Var(v_{t})+Var(v_{t-1})+\cdots+Var(v_{1})
> $$
>
> 随机游走序列可表示为历史白噪声的线性组合，因此对这个式子两边同时求方差，不难看出，结论是 $Var(Y_t) = t \sigma^2$ ，意味着方差是随时间变化的函数，不符合协方差平稳的条件。

> **白噪声** 
> 白噪声的取值具有随机性，但由于白噪声零均值、同方差、无自相关，是符合协方差平稳（弱平稳）的。再次回顾白噪声的定义：
> > $E(\varepsilon_t)=\mu$
> $Var(\varepsilon_t)=\sigma^2$
> $Cov(\varepsilon_t, \varepsilon_s)=0, t \neq s$
> 或者说具有**零均值**、**同方差**、**独立同分布**
>
> 协方差平稳的要求：
> > $Cov(Y_t, Y_{t-h}) = \varphi^h Var(y_t)$，意味着协方差是一个只和间距 $h$ 有关，和时间 $t$ 无关的函数，不随时间变化而变化。个人认为这一点也是自相关的体现。
> > $Var(Y_t) = \frac{\sigma^2}{1-\varphi^2}$， 方差是一个常数。
> > $E(Y_t)=\frac{\mu}{1-\varphi}$ ，均值是和时间 $t$ 无关的常数，不随时间变化而变化
> > 总结起来就是，方差（波动率）是与时间无关的常数，均值是与时间无关的常数，协方差是只与时间的间隔有关、和t无关的常数。


##### ADF检验
DF检验针对$AR(1)$，如果拓展到高阶p，就会使用ADF检验（Augmented Dickey–Fuller test），其核心思想和DF是一致的，即：**所有滞后项 $y_t$ 的系数，均有 $|\varphi_i|<1$**。

以高阶AR为例讲解ADF单位根检验。

$$
y_t= \varphi_1y_{t-1}+\varphi_2y_{t-2} + \cdots + \varphi_p y_{t-p}+\varepsilon_t
$$

AR(p) 平稳的含义是：AR(p) 所有滞后项系数 $|\varphi_i|<1$ ，由于需要求解的个数较多，我们可以引入滞后算子 $y_{t-1}=Ly_t$ ，把滞后项y全部转换成 $y_{t-i}=L^iy_{t}$ ，就可以得出：

$$
y_t=\frac{\varepsilon_t}{1-\varphi_1 L-\varphi_2 L^2-\cdots-\varphi_p L^p}
$$

其中，我们将分式的分母称为滞后项系数 $\varphi_i$ 的 **特征方程**，这比直接看AR(p)过程更加简洁。平稳性的判断，等价于分母这个关于滞后项系数 $\varphi_i$ 的 **特征方程** 的求解情况，当且仅当存在单位根，分母为0。因此，化简构造特征方程=0，并判断：

$$
1= \varphi_1 L+\varphi_2 L^2+\cdots+\varphi_p L^p
$$

如果 **特征方程无单位根，那么序列平稳**，这个条件等价于上面的 **如果所有滞后项系数 $|\varphi_i|<1$ 那么序列平稳**。数学上把模长等于1的解称之为单位根，考虑实数域和虚数域，从几何上看，单位根是落在单位圆上的，即 $\lVert L \lVert =|L|=1 $。一旦有这样的单位根，就意味着方程是随机游走模型，序列值是纯随机的，不符合平稳性的定义。无单位根 可以简单理解为：**特征方程所有解都大于1，不存在模长等于1的解**。之所以用求解特征方程的方法来判断平稳性，是因为只需要解方程，判断是否有解模长（因为可能是复数）等于1即可。而直接判断滞后项系数，需要判断绝对值是否小于1，比解单位根麻烦。

<img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312220238345.webp" style="zoom: 50%;" />

因此，同样列出假设，并求出解的情况进而判断平稳性，这就是ADF的做法和原理。
* 原假设$H_0$：存在 $|\varphi_i|=1$，等价于存在 $\lVert L \lVert =|L|=1 $，也就是特征方程存在单位根，意味着序列不平稳。
* 备择假设$H_1$：任意 $|\varphi_i|<1$，等价于 $\lVert L \lVert > 1 $，也就是特征方程不存在单位根，意味着序列平稳。

对于不平稳的序列，可以尝试进行差分，再进行ADF、DF检验，例如：数据如果进行3阶差分，就称之为3阶单整，记作I(3)。

>  **假设检验的原理**
>
>  假设检验的原假设$H_0$是：**某个小概率事件会发生**。置信度水平α是这个小概率事件发生的可能性的最低要求。生活中我们一般认为：当事件发生的可能性小到一定的程度$P<\alpha$，那么就可以认为这个小概率事件不会发生，也就是说应该**拒绝 `这个事件会发生` 的原假设**，反之如果事件发生的概率大于一定的程度，就**不能认为这个事件不会发生**，不能拒绝原假设$H_0$。
>
>  另一个角度，α是原假设为真时拒绝原假设的概率的临界值，被称为去真概率的临界值也就是置信度水平，如果得到的实际的去真概率P值小于临界值，说明不会去真，应该拒绝去真的原假设；反之，去真概率P大于临界值，说明去真这个原假设不是不可能发生，不能拒绝原假设。
>
>  另一个角度，1-α是：当原假设为真的时候，接受原假设的概率，也就是不去真的最小要求，如果计算得出的1-P大于1-α这个最低要求，说明不可以拒绝原假设；反之应当拒绝原假设。
>
>  需要注意的是，这里判断的结果是：
>
>  * 不拒绝原假设
>
>  * 拒绝原假设（不是接受备择假设）
>
>  由于我们假设检验构建的统计量、P值都是针对原假设的，因此得出的结果也是关于原假设的结果。备择假设的含义是：选取一个和原假设对立的假设条件，因此当我们通过统计检验得出**拒绝原假设**的结论后，可以考虑选取备择假设作为备用选择。因为假设检验是针对原假设做的检验，而没有检验备择假设，所以假设检验的得出的结论应该表述为拒绝原假设，而不能直接说接受备择假设。
>
>  检验的类型有单侧检验、双侧检验。上面是以单侧检验为例讲解的，置信度$\alpha$是去真概率的临界值，对应的t统计量就称之为 **上 $\alpha$ 分位点**。 如果是双侧检验，实际上可以通过取绝对值，转化为单侧检验。双侧检验的去真概率实际上来源于两侧，以t分布为例，左右各占 $\frac{\alpha}{2}$，取绝对值后，只看正区间，可以认为此时去真概率的临界值是 $\frac{\alpha}{2}$，接下来就可以单侧检验的方法进行判断。
>
>  形象化理解：
>
>  以谈恋爱和别人约会为例， $H_0$ 是你的约会对象， $H_1$ 是潜在可约会对象，置信度 $\alpha$ 是你认为的约会的好感。假设检验的过程，就是约会判断对 $H_0$ 好感的过程，假如完全没达到你心中的预期，那么你一定会拒绝和他继续发展；假如这种好感足够大，你就不会拒绝和他继续往下发展。假如你拒绝和他继续往下发展，就可以考虑此时潜在的其他约会对象例如 $H_1$。
>
>  单侧检验的概率就是：你知道他是你的真命天子，但你拒绝了他的概率。假如这个概率足够小，就可以认为你不会拒绝你的真命天子。
>
>  双侧检验的概率就是：首先是统计量的含义，越往右是约会对象表现得越好，越往左是约会对象表现的好坏程度。实际上你心中对约会对象有一个预期的上限和下限，如果他表现得超过你的预期的上限，你会认为他是伪装出来的假象，他太虚伪了，所以会拒绝他；如果他表现得太差没有达到你预期的下限，你也会觉得他不够好，也会拒绝他。
>
>  另一种理解：
>  以刑事审判作比喻，我们假设被告是无辜的，接下来我们询问证据是否与假设相符？如果不是，我们可以拒绝假设，即被告不是无辜的；如果是，我们无法拒绝，即不能证明被告不是无辜。注意：不要“接受”假设

#### Yule-Walker方程
对于均值为0的 AR(p) 模型，如果和自相关函数联系起来，就可以得到**Yule-Walker方程**。作用是：
* 根据AR(p)模型，进而推出自相关系数和偏自相关系数
* 参数估计

主要的结论和性质如下：

$$
\begin{cases}
    \Gamma \Phi = \theta_p \\
    \sigma^2 = \gamma_0 - \Phi^T\theta_p \\
\end{cases}
$$

对任意自协方差，当 $k\geq p+1$，有 $\gamma_k=\phi_1\gamma_{k-1}+\cdots+\phi_p\gamma_{k-p}$

$$
\begin{cases}    
    \text{ACF向量} & = & \frac{1}{\gamma_0} \theta_p \\
    \text{PACF向量} \Phi & = & \Gamma_p^{-1} \theta_p
\end{cases}
$$

PACF $\Phi$ 得到的就是序列滞后项的系数，因此这也是AR模型的参数估计方法之一。当然，这一估计存在一些问题，因此我们更常用最小二乘估计或极大似然估计。


> **Yule-Walker方程的相关推导及性质**
> $$
> Y_t=\varphi_1Y_{t-1}+\varphi_2Y_{t-2} + \cdots + \varphi_p Y_{t-p}+\varepsilon_t
> $$
>
> 两边同时乘以$Y_{t-1}$，然后式子两端同时取均值，利用公式 $\gamma_k=E(X_tX_{t+k})$，并且由于$\varepsilon_t$是白噪声所以有 $E(\varepsilon_t y_{t})=0$，上式就变为
> $$
> \gamma_1=\varphi_1 \gamma_0 + \varphi_2 \gamma_1 + \cdots \varphi_p\gamma_{p-1} + E(\varepsilon_t y_{t-1})
> $$
>
> 即 $\gamma_1=\varphi_1 \gamma_0 + \varphi_2 \gamma_1 + \cdots \varphi_p\gamma_{p-1}$，可以递推出剩余各式
> $$
> \begin{cases}
> \gamma_1 & = & \varphi_1 \gamma_0 &+&\varphi_2 \gamma_1 &+& \cdots & \varphi_p\gamma_{p-1} \\
> \vdots && \vdots && \vdots && \ddots & \vdots\\
> \gamma_p & = & \varphi_1 \gamma_{p-1} &+&\varphi_2 \gamma_{p-2} &+& \cdots & \varphi_p\gamma_{p-1} \\
> \end{cases}
> $$
>
> 整理为矩阵，就是
>
> $$
> \begin{matrix}
> \underbrace{\begin{bmatrix}
> \gamma_0 & \gamma_1 & \gamma_2 & \cdots & \gamma_{p-1} \\
> \gamma_1 & \gamma_0 & \gamma_1 & \cdots & \gamma_{p-2} \\
> \gamma_2 & \gamma_1 & \gamma_0 & \cdots & \gamma_{p-3} \\
> \vdots   & \vdots   & \vdots   &\ddots  & \vdots       \\
> \gamma_p & \gamma_{p-1} & \gamma_{p-2} & \cdots & \gamma_{0} \\
> \end{bmatrix} } \\ \Gamma
> \end{matrix}
> \begin{matrix}
> \underbrace{\begin{bmatrix}
> \varphi_1 \\
> \varphi_2 \\
> \varphi_3 \\
> \vdots    \\
> \varphi_p \\
> \end{bmatrix}} \\ \Phi
> \end{matrix}=
> \begin{matrix}
> \underbrace{\begin{bmatrix}
> \gamma_1 \\
> \gamma_2 \\
> \gamma_3 \\
> \vdots    \\
> \gamma_p \\
> \end{bmatrix}} \\ \theta_p 
> \end{matrix}
> $$
>
> $$
> \begin{cases}
> \Gamma \Phi = \theta_p \\
> \sigma^2 = \gamma_0 - \Phi^T\theta_p \\
> \end{cases}
> $$
>
> 并且，对任意自协方差可得出递推式（加绝对值是因为要让步长为正数），有 
> $$
> \gamma_k=\phi_1\gamma_{k-1}+\cdots+\phi_p\gamma_{k-p},k\ge p+1
> $$
>
> 其中，$\Gamma$ 是自协方差矩阵，$\Phi$ 是**偏自相关系数PACF向量**，$\theta_p$ 是自协方差向量。
>
> 可以根据求相关系数 $\rho_k$ 的方法，对自协方差向量 $[\gamma_1 \gamma_2 \cdots \gamma_p]^T$ 数乘 $\frac{1}{\gamma_0}$ ，得到 **相关系数ACF向量** $[\rho_1 \rho_2 \cdots \rho_p]^T$
> $$
> \text{ACF向量}
> \begin{bmatrix}
>  \rho_{1} \\
>  \rho_{2} \\
>  \rho_{3} \\
>  \vdots   \\
>  \rho_{p} \\
> \end{bmatrix}=
> \frac{1}{\gamma_0}
> \begin{bmatrix}
>  \gamma_{1} \\
>  \gamma_{2} \\
>  \gamma_{3} \\
>  \vdots   \\
>  \gamma_{p} \\
> \end{bmatrix} =
> \frac{1}{\gamma_0} \theta_p
> $$
>
> 根据Yule-Walker模型，可以得到滞后项的系数估计值，也就是PACF
> $$
> \text{PACF向量} \Phi=
> \begin{bmatrix}
>  \varphi_1 \\
>  \varphi_2 \\
>  \varphi_3 \\
>  \vdots    \\
>  \varphi_p \\
> \end{bmatrix} = \Gamma_p^{-1} \theta_p
> $$
>
> Yule-Walker的估计实质上存在一些问题：
> * Yule-Walker建立在均值为0的AR(p)模型基础上，假如不为0就会利用去均值化的方法构造均值为0的新AR(p)序列，这个过程会引入误差。
> * 对自协方差进行估计时，由于使用的样本不一样，估计的准确程度就会不一样
> * $\sigma^2 = \gamma_0 - \Phi^T\theta_p $ 作为方差的估计量，不能完全保证方差一定为正数，会产生逻辑上的矛盾。
>



#### 极大似然估计

似然函数是
$$
L(\theta,\sigma^2)=-\frac{T-P}{2}ln \sigma^2-\frac{1}{2\sigma^2}\sum_{t=p+1}^{T}(Y_t-X_t^T\theta)^2
$$
求出 $max L$ 就可以求出参数估计值。

> **极大似然估计**
> 假如知道某个事件服从某种概率分布模型，例如 $f(X1, X2)$ 服从正态分布，但是不知道正态分布这个分布模型的具体的参数取值，就可以采用极大似然估计，来获得从已知的概率的角度（例如：已经确定事件X服从正态分布，仅仅不知道正态分布的具体形状）的最有可能的参数取值。
>
> > 示例：已知男生和女生身高的分布都各自符合正态分布，现在有一堆样本点，需要判断这一堆样本点的数据的性别。
>
> <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312220238964.jpeg" style="zoom: 50%;" />
> 
> 根据假设的条件概率（参数未知的概率分布模型），列出似然方程并求解最大值，得到的估计量就是极大似然估计，也就是直观认为最有可能发生的概论的估计。图中样本点从概率角度来看，最符合蓝色的正态分布，因为绝大多数样本点都分布在蓝色的模型中，并且分布的密度和蓝色正态分布模型的密度十分对应。概括起来：
>
> **似然** 就是：根据这一堆样本点，寻找合适的概率分布模型
> **概率** 就是：根据已知的概率分布模型，寻找某个取值出现的可能性 
>
> 极大似然估计的特点：
>
> * 比其他估计更简单
> * 收敛性：**无偏性**，或渐进无偏，样本数量增加收敛性质会更好。
> * 条件概率的假设至关重要，假设如果出现偏误，估计结果会很差。也就是：**不一定有最小方差性**

---

#### 最小二乘估计

$$
\hat{\theta} = \left[\sum_{t=p+1}^{T}X_t X_t^T\right]^{-1} \left[\sum_{t=p+1}^{T}X_tY_t\right] \\
\hat{\sigma^2} = -\frac{1}{T-P}\sum_{t=p+1}^{T}(Y_t-X_t^T\hat{\theta})^2
$$

### MA模型
假如我们认为**当期值是历史白噪声的线性组合**，大部分时候的时间序列数据就像池塘里的水是稳定的，除了偶尔因为风吹草动、丢石头这样的冲击因素导致波动，这就意味着不同时间的Yi没有自相关性，**不能拿Yi的过去值来预测，而是应该用白噪声的线性组合来预测**。

$$
Y_t=\mu+\theta_{1}\varepsilon_{t-1}+\theta_{2}\varepsilon_{t-2}+\cdots +\theta_{q}\varepsilon_{t-q}
$$

这个历史白噪声的范围就是滞后的阶数q

### AR和MA的转化

$$
\ce{AR(1) & <->[Koyck转换] & MA(\infin)} \\
\ce{AR(\infin) & <->[可逆性] & MA(1)}
$$


### ARMA模型和ARIMA
我们也可以综合考虑，认为两种情况同时存在。这就是我们的ARMA模型。其实也很好理解：
以MA模型为基础，把 $Y_t$ 这一期的白噪声 $\mu$ 替换为AR模型，可以认为这一期的白噪声的作用等同于 $Y_t$ 历史值线性组合的作用，这就是ARMA公式的由来

$$
\begin{aligned}
    Y_t=
    \begin{matrix}
    	\underbrace{c+\varphi_{1}Y_{t-1}+\varphi_{2}Y_{t-2}+\cdots +\varphi_{p}Y_{t-p} +\varepsilon_t}\\ AR部分
    \end{matrix}+
    \begin{matrix}
    	\underbrace{\theta_{1}\varepsilon_{t-1}+\theta_{2}\varepsilon_{t-2}+\cdots +\theta_{q}\varepsilon_{t-q} } \\MA部分
    \end{matrix}
\end{aligned}
$$

可以对ARMA模型进行I阶差分处理，以图消除趋势、季节性因素，得到`ARIMA模型`

* AR部分考虑过去值对现值的影响，参数是p
* MA部分考虑过去预测的误差对当前值的影响，参数是q
* I部分代表平稳化，参数是d


## VAR模型

假设多个序列线性组合的新序列也具有平稳性，那么称之为协整。利用单个序列的思想，线性组合出的新序列应该也是存在自相关的，那么同样判断：

* 新序列是有自相关的平稳序列

如果自相关类型是MA，那么必然平稳，此处由于是向量形式，记作VMA。因此，需要进行判断的是向量形式的AR模型的平稳性，记作VAR。进一步地，可以建立误差修正模型，解决多维数据存在的多重共线性问题。

此处以VAR为例，讲解多维数据的处理思路与方法。

### 协整检验（平稳性）

针对单个序列，可能存在的平稳性我们称之为单整。而如果我们有多个序列，即使这些序列自身不平稳，考虑序列之间长期存在的关系，统一经过 $I$ 阶差分、线性组合出新序列是平稳的，我们就称：这些序列间存在协整关系。协整关系如果存在，说明多个序列可能各自都有波动（序列自己不平稳），但长期来看有相同的变动关系或者叫变动比例（同甘苦共患难，同起落），那么他们线性组合出的新序列平稳。

例如：设居民收入时间序列 $Y_t$ 为1阶单整序列，居民消费时间序列 $C_t$ 也为1阶单整序列，如果二者的线性组合构成的新序列 $a_1 Y_t+a_2C_t$ 为0阶单整序列，则可认为序列 $Y_t$ 与之 $C_t$ 间是（1，1）阶协整。

经济意义：两个变量，虽然它们具有各自的长期波动规律，但是如果它们是协整的，则它们之间存在着一个长期稳定的比例关系。例如居民收入 $Y_t$ 和居民消费 $C_t$ ，如果它们各自都是1阶单整，并且它们是（1，1)阶协整，则说明它们之间存在着一个长期稳定的比例关系，而这个比例关系的度量就是“消费倾向”。长期来看，消费倾向应该是不变的。

协整关系可能存在于：

* 一元线性回归，Y和X之间，这样的协整称之为一阶协整；
* 多元回归或有X的滞后项，多个时间序列数据（VAR模型）、面板数据等，这样的协整称之为多阶协整。

不同协整类型判断方法不同：

* 一阶协整：Engel-Granger两步法（EG）
* 多阶协整：Johansen检验（JJ）

重点讲EG的过程，从原理上看，**EG检验**其实就是：

* 对Y和X进行OLS，目的是得到残差$u_i$
* 对残差进行ADF分析，如果平稳，则存在一阶协整，不平稳则不存在一阶协整

其假设是：

* 原假设$H_0$：无协整
* 备择假设$H_1$：有协整

**Johansen检验**包括两种方法：迹统计量检验（$ \lambda_{trace} $）和最大特征根检验（$ \lambda_{max} $），两个方法可结合起来确定结果。

> **迹统计量检验（$ \lambda_{trace} $）：**
> 迹统计量检验是用来判断是否存在协整关系的。
>
> **原假设（$ H_0 $）**：存在最多 $ r $ 个协整向量。 （即协整向量$协整向量个数\le r$）
> **备择假设（$ H_1 $）**：存在超过 $ r $ 个协整向量。（即协整向量$协整向量个数>r$）
>
> 其计算步骤如下：
>
> 1. 计算特征根（Eigenvalues）$\lambda_i$。
> 2. 计算迹统计量：
>    $$
>    \lambda_{trace} = -T \sum_{i=r+1}^{k} \ln(1 - \lambda_i)
>    $$
>    其中，$ T $ 是样本量，$ k $ 是系统中的变量数，$ r $ 是假设的协整关系个数。
> 3. 对不同的协整向量个数（从0到k-1）计算迹统计量，逐步比较其值和临界值，以确定协整向量的数目。若统计量大于临界值，则拒绝原假设（即有 $ r $ 个协整向量）。

> **最大特征根检验（$ \lambda_{max} $）：**
> 最大特征根检验也用于判断协整关系。
>
> **原假设（$ H_0 $）**：存在 $ r $ 个协整向量。 （即协整向量$协整向量个数=r$）
> **备择假设（$ H_1 $）**：存在 $ r+1 $ 个协整向量。（即协整向量$协整向量个数=r+1$）
>
> 其计算步骤如下：
>
> 1. 同样计算特征根 $\lambda_i$。
> 2. 计算最大特征根统计量：
>    $$
>    \lambda_{max} = -T \ln(1 - \lambda_{r+1})
>    $$
>    其中，$ \lambda_{r+1} $ 是第 $ r+1 $ 大的特征根。
> 3. 对不同的协整向量个数（从0到k-1）进行最大特征根检验，比较其值和临界值。如果统计量大于临界值，则拒绝原假设，表示存在 $ r+1 $ 个协整向量。

此处放一个例题：

> （感谢bilibili粉丝@NPKd提供的例题）
>
> | r    | $λ_{max}$ | $95\%$ critical value |
> | ---- | ----- | ------------------ |
> | 0    | 38.65 | 30.26              |
> | 1    | 26.91 | 23.84              |
> | 2    | 10.67 | 17.72              |
> | 3    | 8.55  | 10.71              |
>
> “数小率大不拒绝$H_0$，数大率小拒绝$H_0$”，对比此处构造统计量与临界值大小，$r=0$、$r=1$时均大于临界值，应拒绝原假设，而$r=2$时小于临界值，不拒绝具有两个特征根的原假设。



### 格兰杰检验（序列间相关性）

对多个序列进行分析后发现，序列的线性组合平稳，因此序列之间或者是序列的线性组合具有平稳性。以多阶协整为例，多阶协整存在于Y和多个X之间，说明序列间可能存在变动趋势的相关性。所以我们还可以对变量间的关系进行研究，观察是否有某个变量的历史值对另一个变量的现值有影响（有影响，代表可以用这个原因去预测需要的结果），这种关系我们称之为格兰杰因果，具体来说有四类：
$$
\ce{X_{t-i}&->[引起]&Y_t}	\qquad&\text{$\sum_{i=1}^{m}a_i$ 显著不为零，$\sum_{i=1}^{m}\beta_i$ 显著为零，X是Y的格兰杰原因} \\
\ce{X_t&->[引起]&Y_{t-i}}  \qquad&\text{$\sum_{i=1}^{m}a_i$ 显著为零，$\sum_{i=1}^{m}\beta_i$ 显著不为零，Y是X的格兰杰原因} \\
\ce{X_{t}&<->[相互影响]&X_t} \qquad&\text{$\sum_{i=1}^{m}a_i$ 显著不为零，$\sum_{i=1}^{m}\beta_i$ 显著不为零，X和Y互为格兰杰原因} \\
\ce{X_{t}&<->[互不影响]&X_t} \qquad&\text{$\sum_{i=1}^{m}a_i$ 显著为零，$\sum_{i=1}^{m}\beta_i$ 显著为零，X和Y不互为格兰杰原因}\\
$$
如果发现某个变量A是另一个变量B的格兰杰原因，说明这个变量A的滞后值能提高预测另一个变量B的能力，A的前期变化可以引起Y现在的变化。特别注意，格兰杰检验可以反映的是**统计意义上的因果关系**。

数学形式是：
$$
Y_t=\sum_{i=1}^{m}a_iX_{t-i} + \sum_{i=1}^{m}\beta_i Y_{t-i} + \mu_{1t} \\
X_t=\sum_{i=1}^{m}\lambda_iY_{t-i} + \sum_{i=1}^{m}\delta_i X_{t-i} + \mu_{2t}
$$

* 原假设H0：A不是B的格兰杰原因，A不能引起B的变化
* 备择假设H1：A是B的格兰杰原因，A可以引起B的变化

例如下面

![](https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312220238286.webp)

* 投资额对销售额的检验不显著（数小率大），不拒绝H0;
* 销售额对投资额的检验显著（数大率小），拒绝H0，选H1，销售额是投资额的格兰杰原因。

### 误差修正模型


---

**总结**
平稳性针对单个序列，称为**单整**；针对多个序列并研究多个序列的线性组合的平稳性，称为**协整**。

**单整**的类型是：所有的MA(q)和特定的AR(q)。对AR(q)的平稳性的检验方法是：DF和ADF检验，原假设 $H_0$ 都是AR模型存在单位根，序列非平稳，备择假设 $H_1$ 是平稳。DF针对的是`AR(1)`一阶自相关的情况，ADF是对 `AR(1)` 高阶的拓展。核心思想都是：研究是否存在滞后项系数绝对值不小于1，等价于判断特征方程是否存在单位根。

**协整**又分为一阶协整（Y和X）和多阶协整（存在多个X的滞后项）：

* 一阶协整的检验方法：Engel-Granger两步法，对于多个序列，如果序列不平稳则可以尝试差分，目的是**得到 $I$ 阶单整序列**，进而OLS得到残差$u_i$，最后对残差$u_i$进行ADF检验，残差平稳则有协整。
* 多阶协整的检验方法：Johansen检验

存在协整的数据可以进一步做格兰杰检验，考虑序列间是否存在统计意义上的因果性。



---

## （残差）白噪声检验

> 人生总是起起落落、起起落落......

我们现在已经确定了序列是有自相关的平稳序列，为了让残差是无自相关的平稳序列，接下来就要 **对残差进行白噪声检验**，这是因为 ：
* 确定残差是白噪声，意味着残差项序列没有自相关，是随机的，符合古典假定，OLS估计是准确的；
* 如果序列残差存在自相关性，残差就不是随机的白噪声，违反古典假定，OLS估计不是准确的。

所以我们可以利用自相关检验的方法，通过判断 **序列残差的自相关性**，来检验残差是否是白噪声。

一开始对序列是否是白噪声，我们可以直接看收益率图进行简单判断：收益率图趋势明显、数据波动集中，我们大致就认为数据应该不是完全随机的，所以序列不是白噪声。例如以下四幅图，可以看出来：
1. 第一幅是白噪声，完全随机，是 平稳序列；
2. 第二幅随机游走，没有固定趋势，均值、方差波动程度较大，是 非平稳序列；
3. 第三幅趋势上升，但均值岁时间增加而增加，是 非平稳序列；
4. 第四幅曲线大致在一条水平线上下波动，波动程度前后变化较小，均值没有明显随时间变动，可以认为是平稳的。

<img src="https://pic2.zhimg.com/v2-524c2d531e48841c91b5705a11c8ea3d_r.jpg" style="zoom: 25%;" />

但残差项往往可能波动比较复杂，需要更多更深入的办法提高判断的准确性。

由于白噪声零均值、同方差、无自相关，其自相关系数的情况是：
* $\rho_0=1$，（自己当然和自己百分百相关）
* $\rho_0=0$，（体现无自相关性）

> **Barlett定理**
> 时间序列数据如果纯随机，对于其n期的观察序列，其滞后k期的自相关系数 $\rho_k = \frac{Cov(u_i, u_{i-k})}{Cov(u_i, u_i)} = \frac{\gamma_k}{\gamma_0}$ 的估计值 $\hat{\rho_k}$ 在$k\neq 0$的时候，近似服从均值为零、方差为观察期n的倒数的正态分布
>  $$
> \hat{\rho_k} \sim N (0, \frac{1}{n})
> $$
> 

可以看出，纯随机的数据的相关系数的均值是0，那么这些数据之间必然不能有相关性。已知序列残差的性质：同方差、零均值，因此，**序列残差是否是白噪声的判断，就可以利用对平稳性或者自相关的判断来进行**。
* 从平稳性入手，就是指对残差进行平稳性分析（ACF、PACF）：
  * 序列不平稳，残差大概率不是白噪声
  * 序列平稳，残差可能是白噪声
* 从自相关性入手，使用BP检验、LB检验来检验序列残差是否存在自相关性：
  * $H_0$：假如残差不存在自相关性，零均值、同方差的序列残差是白噪声
  * $H_1$：假如残差存在自相关性，残差项不随机，肯定不是白噪声。



### 自相关函数图观察法
判断序列的残差是否是白噪声的第一个办法：ACF和PACF判断序列的稳定性，进而推断残差是否是白噪声。

一般来说，平稳序列的自相关函数、偏自相关函数会迅速退化到0，滞后期越短，相关性越高（滞后期为0相关性为1）。因此假如自相关函数退化比较慢、或者存在周期性波动、或者存在先减后增等情况，也就是意味着较多的相关系数在边界外，自相关函数没有截尾或者拖尾，也就是说序列是不平稳的，那么残差就不是白噪声。因此 **残差白噪声的判断等同于 对序列平稳性的分析，序列不平稳残差必然不是白噪声**。

### Box-Pierce检验法

我们可以利用假设检验，构建关于ACF的Q统计量，认为应该服从某些分布。根据 Barlett定理，当序列如果有足够的自相关性时，这个序列必然不是白噪声。因此，Box-Pierce检验法用序列的自相关系数ACF构建 $Q_{bp}$ 统计量，并和卡方临界值 $\chi^2_{\alpha}(m)$ 对比，检验序列的**整个m阶时期内**是否存在足够的自相关性。

$$
Q_{bp}=n \sum^{m}_{k=1}\hat{\rho_k}^2
$$

m是最大滞后阶数（一般是手动设定，是临界值的自由度），n是观察期数，$\hat{\rho_k}$  是k阶自相关系数ACF的估计值。

此处我们检验残差自相关性的程度，检验对象是序列的残差的所有m阶自相关系数 $\hat{\rho_k}$  。假设ACF的分布满足临界值的卡方分布 $\chi^2(m)$ ：

* ==$H_0$：m阶自相关系数均为0，残差完全无自相关，那么零均值同方差，是白噪声==
* ==$H_1$：假如原假设残差序列上完全不存在自相关性这个假设的可能性不够强，因此要拒绝原假设，可以认为存在一定的自相关性，那么残差项肯定不随机，不符合白噪声无自相关的假定，因此不是白噪声。==

同样是用那个口诀，数小率大接受原假设。


### Ljung-Box检验法

第三个方法是Ljung-Box检验法，可以理解为是BP检验的改进升级版，反正最后使用起来也是对比构建的QLB统计量，数小率大接受原假设。LB检验同样假设ACF、PACF符合某种分布，序列的残差在**整个序列**上自相关性的程度：

* ==$H_0$：假如残差序列上完全不存在自相关性这个假设的可能性足够强，零均值、同方差的序列残差是随机的，也就是说残差无自相关，满足白噪声的所有假定，所以是白噪声==
* ==$H_1$：假如原假设残差序列上完全不存在自相关性这个假设的可能性不够强，因此要拒绝原假设，可以认为存在一定的自相关性，那么残差项肯定不随机，不符合白噪声无自相关的假定，因此不是白噪声。==

$$
Q_{LB}=n(n+2)\sum_{k=1}^{m}\frac{\rho^2_k}{n-k}
$$







## 条件异方差模型

> 一个套娃解决不了问题，那就再套一个......

之前的模型之所以完美，有两方面的原因

* 序列是平稳的自相关模型
* 残差是平稳的无自相关模型

当残差不再是完美的白噪声时，条件异方差模型给出了一种解决思路。

OLS古典假定中，残差 $u_i$ 是白噪声，所以是**同方差**的。但现实中的其他时间序列经常存在**波动集群**的现象，**大波动后跟着大波动，小波动后跟着小波动**，例如：2008年金融危机爆发的时候股价波动极为猛烈，而在其他时候股价变动会比较平缓。

为了描述这种波动集群现象，我们用残差 $u_i$ 来代替随机误差项 $\varepsilon_t$，引入残差的条件异方差模型。核心是：把残差的波动率视为方差 $\sigma^2$，条件异方差意味着：残差的方差 $\sigma^2$ 也就是波动率不是常数，而是一个随时间t变化而变化的函数 $\sigma^2_t$，违反计量经济学古典假设 $\varepsilon_t$ **同方差** 的假定，这会导致OLS出现误差。

>  **波动集群**
>  形象地理解，序列值 $Y_t$ 受残差 $u_t$ 的影响，残差 $u_t$ 受其自身方差 $\sigma_t^2$ 的影响，而残差的方差 $\sigma_t^2$ 是受残差的平方滞后项 $u_{t-i}^2$ 影响.......因此一旦在 $t-i$ 时刻有一个突发事件，表现为 $u_{t-i}$ 的波动变大即 $u_{t-i}^2$ 扩大，那么 $t$ 时刻的方差就会受过去的残差平方 $\varepsilon_{t-i}^2$ 的扩大而变得更大，进而 $\varepsilon_t$ 的波动就会进一步变得更大，以此类推，也就是 
>
>  * **大波动跟着大波动**；
>  * 反之 **小波动跟着小波动**

因此对于这个不确定的方差$\sigma^2_t$（残差的波动率），ARCH模型和GARCH模型用类似于此前我们利用时间序列 $Y_i$ 的序列相关性来预测$Y_i$一样，利用方差的序列相关性来预测方差 $\sigma^2_t$ 。要弄清残差的条件异方差性(conditional heteroscedasticity)，就要重点研究 $Y_t$ 的残差$u_i$自身的特点。你可以认为残差的条件异方差性的由来就是：残差项 $u_i$ 在q个滞后期上分布特点不同，存在条件异方差性 $\sigma^2_t$ 。所以ARCH模型、GARCH模型利用这一点，把方差 $\sigma^2_t$ 作为被解释变量，进行建模、预测。

* ARCH模型基本思想是：残差 $u_i$ 在$t$时刻的方差 $\sigma^2_t$ 和历史q期的残差平方 $u_{t-i}^2$ 存在序列相关性（并且是同向的），并且 $u_i^2$ 自身是服从AR(q)自回归自相关的，因此残差 $u_t$ 存在波动集群的性质就可以用历史q个时刻上的残差平方 $u_{t-i}^2$  存在作为解释变量去回归方差 $\sigma^2_t$ 。
* GARCH模型则在ARCH基础上，认为 $\sigma_t^2$ 自身也存在p阶自回归自相关，因此解释变量既包括历史时刻上的残差平方 $u_{t-i}^2$ ，还包括 被解释变量的滞后项$\sigma^2_{t-i}$ 。

> **序列相关性**，个人理解侧重于体现两个 **不同时点** 的数据之间的相关性，突出的是时间序列的特征。

可以看出条件异方差的经济含义是很明确的：**将资产的波动率描述为条件异方差，条件异方差代表资产波动率不为常数，而是一个随时间变化的函数，就可以用方差的情况来体现资产的风险。**。

### ARCH模型
#### 含义

> 严格来说，ARCH模型适用于波动率预测，例如研究股票价格的波动等。此处为了便于大家理解ARCH、GARCH模型的作用，本文承接上文对序列建立自相关模型的内容：假设已经根据数据的自相关特点，建立了序列的自相关模型（ARMA），此时发现残差序列不是白噪声。我们知道，如果拟合模型的残差是白噪声，那么说明我们的建模很好地提取了数据的特征，建模是成功的。因此，为了提高我们模型的拟合效果，学者提出了ARCH、GARCH模型——用于解决条件异方差问题。
> 
> 实际应用中，自相关模型常用于预测各类价格序列，ARCH、GARCH模型常用于预测波动率，二者适合的对象不同，因此不一定有“谁先谁后”这类问题。

此前我们预测的都是被解释变量 $Y_i$ 的期望值，而此处ARCH模型和GARCH模型预测的是残差 $u_i$ 的方差 $\sigma^2$ 的期望值，目的是解决我们计量经济学 **同方差** 的假定被违反时的问题。

古典假定中随机扰动项 $\varepsilon_t$ 是同方差的，所以残差作为随机扰动项的估计，应该是同方差的，不应该有条件异方差性，残差的波动率 $\sigma_t^2$ 应该是一个常数，而不应该是一个关于 $t$ 的变量。而现实生活中，数据不一定完美符合古典假定，例如经济危机时期股价的方差必然比经济平稳时期更大。这种现象，也被称为**波动集群**，或者叫**条件异方差性**。


> **波动集群**
>
> 形象地理解，序列值 $Y_t$ 受残差 $\varepsilon_t$ 的影响，残差 $\varepsilon_t$ 受其自身方差 $\sigma_t^2$ 的影响，而残差的方差 $\sigma_t^2$ 是受残差的平方滞后项 $\varepsilon_{t-i}^2$ 影响.......因此一旦在 $t-i$ 时刻有一个突发事件，表现为 $\varepsilon_{t-i}$ 的波动变大即 $\varepsilon_{t-i}^2$ 扩大，那么 $t$ 时刻的方差就会受过去的残差平方 $\varepsilon_{t-i}^2$ 的扩大而变得更大，进而 $\varepsilon_t$ 的波动就会进一步变得更大，以此类推，也就是 
>
> * **大波动跟着大波动**；
> * 反之 **小波动跟着小波动**

要弄清残差的**条件异方差性**(conditional heteroscedasticity)，就要重点研究 $Y_t$ 的噪声 $\varepsilon_t$ 自身的特点。你可以认为残差的条件异方差性的由来就是：不同时期的噪声 $\varepsilon_t$ 分布特点不同，导致残差存在 条件异方差性。

ARCH模型利用这一点，对残差进行建模，基本思想是：残差在t时刻的方差 $\sigma^2_t$ 和上一时刻残差平方和 $\varepsilon_{t-q}^2$ 存在序列相关性。

> 序列相关性，个人理解侧重于体现两个 **不同时点** 的数据之间的相关性。

这意味着：
* 残差的方差 $\sigma_t^2$ 和残差滞后项的平方 $\varepsilon_{t-i}^2$ 存在q阶序列相关，因此方差不是恒定的常数；
* 残差自身 $\varepsilon_t$ 是白噪声，是无自相关的， $\varepsilon_t$ 存在条件异方差性；
* 残差的平方 $\varepsilon_t^2$ 存在q阶自相关，实质上是 $\varepsilon_t^2$ 服从 AR(q)

$$
\sigma_t^2=a_0+a_1\varepsilon_{t-1}^2+\cdots+a_q\varepsilon_{t-q}^2
$$
$$
\varepsilon_t^2=\alpha_0+\alpha_1 \varepsilon_{t-1}^2+ \cdots + \alpha_0 \varepsilon_{t-q}^2 + v_t
$$

其中，$v_t$ 是一个白噪声


根据其特点，可以通过检验残差的波动率 $\sigma_t^2$ 和 历史噪声的平方项 $\varepsilon_{t-i}^2$ 否和存在序列相关性来确定——残差 $\varepsilon_t$ 是否有条件异方差性。也可以说：残差 $\varepsilon_t$ 有条件异方差性，这种情况不符合同方差的假定。

因此 ARCH效应 其实应该准确地定义为： **（残差的平方 $\varepsilon_t^2$ 是）自回归（并且残差 $\varepsilon_t$ 有）条件异方差（ $\sigma_t^2$ ）效应**。

所以其实隐含的条件：ARCH模型建立的基础包括
*  **$\varepsilon_t^2$ 服从AR(q)模型** 
*  **$\sigma_t^2$ 是历史白噪声的平方 $\varepsilon_{t-i}^2$ 的线性组合**

针对时间序列模型，如果存在波动集群的现象，就会违背残差同方差的假定，使残差具有条件异方差性。同方差的假定实际上保证了残差的波动率前后一致。因此ARCH模型利用历史的白噪声的平方项 $\varepsilon_{t-i}^2$ 预测白噪声的波动率 $\sigma_t^2$ ，是AR模型在波动率 $\sigma_t^2$ 上的拓展应用。意义就在于：通过对残差波动率的准确预测，修正残差的条件异方差性给预测带来的偏误，提高预测序列值的准确性。

在ARCH模型中，我们认为残差的方差 $\sigma^2$ 也就是白噪声的波动率 $\sigma_t^2$ 只和白噪声平方的滞后项 $\varepsilon_{t-i}^2$ 有关。波动率 $\sigma^2$ 是历史白噪声滞后项的平方 $\varepsilon_{t-i}^2$ 的线性组合，这样波动率就可以拿历史白噪声的平方项来预测。所以这个**历史白噪声平方项 $\varepsilon_{t-i}^2$ 就不能是白噪声**，否则就会因为具有随机性，无法预测波动率 $\sigma^2$ 。

> **用于预测的量肯定不能是白噪声**，这一原理的应用，整理如下：
> 1. 【OLS】序列$X_i$平稳且不是白噪声，否则无法预测$Y_i$
> 2. 【ARCH模型】$\varepsilon_t^2$ 不能是白噪声否则无法预测 $\sigma^2$ 

你可以这么思考，假如出现一个冲击事件，就会导致某一期开始白噪声特别大，反映到波动率上波动率自然也会变大。也可以看出来冲击事件的传递是持续性、有回声的，就像往池塘里扔石头，水波开始扩散然后一段时间越来越弱渐渐消逝。

因此 ARCH效应 其实应该准确地定义为： **（残差的平方 $u_t^2$ 是）自回归（并且残差 $u_t$ 有）条件异方差（ $\sigma_t^2$ ）的效应**。ARCH效应存在，我们通过建立ARCH模型可以得到：**方差$\sigma^2$不是常量，所以可以利用方差 $\sigma_t^2$  和历史残差项的平方 $u_{t-i}^2$ 有序列相关性，来预测$\sigma_t^2$，因此解释变量$u_t^2$ 不能是随机的，模型假设 $u_t^2$ 服从AR(q)模型，表现为 $u_t^2$ 不是整个序列上都没有自相关（有q期自相关）。**

ARCH模型实际上是AR模型在$u_t^2$上的拓展应用，同时利用方差 $\sigma^2_t$ 和$u_t^2$的序列相关性，对方差 $\sigma^2_t$ 进行预测。意义就在于：通过对残差波动率也就是方差 $\sigma^2_t$ 的准确预测，修正残差的条件异方差性给预测序列值带来的偏误，提高预测序列值的准确性。

#### 检验

在ARCH和GARCH中， **$u^2_t$ 作为解释变量，不能是随机的，表现为 $u_t^2$ 不是在整个序列上都没有自相关（有q期自相关）或$u_t^2$不是白噪声**。 条件异方差的实际的操作，就是利用自相关性的程度的判断（利用ACF、PACF构建Q统计量，探究Q是否满足卡方分布的临界值）来进行的，从 $u_t^2$ 的ACF、PACF的角度来看：

* ACF（BP法、LB法）：判断 $u_i^2$ 的自相关性是否足够弱，如果够弱，就不能认为序列一定不是白噪声，从而不能认为被解释的 $\sigma^2$ 一定是一个常数，没有条件异方差；如果不够弱，那么序列不应该完全无自相关，所以是非随机的，可以认为不是白噪声，可以认为$\sigma^2_t$不是常数，而是具有条件异方差效应。 
* PACF（LM法）：根据 $\sigma^2_t$ 和 $u_t^2$ 序列相关，计算 $\sigma^2_t$这个方程的拟合优度，等效于对 $u_t^2$ 进行自回归检验，也就是分析 $u_t^2$ 在m阶滞后范围内的自相关是否显著。拟合的足够差，说明这个方程不显著，方程的解释变量自回归的特点也不显著，不存在足够的自相关性，可以是白噪声。

> 有的同学就会问：之前讲计量的时候，还不是介绍过其他判断异方差的办法吗？为什么条件异方差的判断不用对异方差本身的判断方法呢？其实是因为每种方法适用的对象和假设的前提不一样。异方差的判断方法，例如：
>
> * GQ检验的对象是递增型异方差，原假设同方差，备择假设存在递增型异方差；
> * Glejser检测对象是递增或递减型异方差，原假设同方差，备择假设递增或递减型方差。并且可推出异方差形式。
>
> 此处 $u_t$ 存在条件异方差体现出来的是： $u_t^2$ 是q阶自回归自相关AR(q)，所以不随机不是白噪声，所以方差 $\sigma^2$ 是随t变化而变化的函数而不是一个常数。因此，条件异方差的判断主要是集中研究：这q期的 $u_i$ 的自相关的程度是否足够强（满足临界的卡方分布）。这种条件异方差不一定是纯递增或纯递减，使用情况不一样。

##### ARCH-LM法（PACF） 

从$\varepsilon^2_t$的角度出发，由于ARCH模型认为它服从AR(p)，因此可以用拉格朗日乘子检验（LM法），目的是探究残差的平方有没有自相关性（和过去几期）。

ARCH模型的第一个式子是 $\sigma_t^2$ 和 $u_{t-i}^2$ 存在序列相关，这个式子作为我们的主回归函数；另一方面，ARCH模型假设$\varepsilon^2_t\sim AR(q)$，所以我们也可以据此建立关于$\varepsilon_t^2$的AR(p)模型作为辅助回归函数。根据模型的含义，考虑到 $u_t^2$ 是非负数，$a_0\ge0$，$\sum_{i=1}^q a_i<1$，$a_i>0(i=1, 2, 3\cdots , q)$。

$$
\sigma_t^2=a_0+a_1 u_{t-1}^2+\cdots+a_q u_{t-q}^2 \\
u_{t}^{2}=a_0+a_1 u_{t-1}^2+\cdots+a_q u_{t-q}^2
$$

$$
Q=nR^2
$$

可以发现第一个式子中，$\sigma^2$ 对应的 $u^2_{t-i}$ 滞后项的系数实质上就是 $u^2_t$ 的偏自相关函数，这两个式子实际上是一致的。这代表可以从两个角度来理解LM法

* 拉格朗日乘子检验（LM法）检验主函数的拟合优度 $R^2$ 来构建Q统计量，并与临界值  $\chi^2_\alpha(P-1)$ 比较，看模型拟合得是否足够差，足够差，说明模型自身解释变量是随机的，不具有预测的功能。其中，P是模型中滞后项的系数的个数。
* 检验解释变量的自相关性是否足够弱，如果足够弱，说明是随机的，用这些随机的解释变量得到的方差就必然是一个常数。

> **不存在自相关** 等价于 **有随机性，不是白噪声** 进而可以推知 **无条件异方差性**

因此，假设其实就是：

* 原假设$H_0$是：无ARCH效应。滞后项$u_{t-i}^2$的系数也就是$u_t^2$的偏自相关系数PACF都等于0，那么 $u^2_t$ 整个序列都没有自相关，那么方差就是恒定的常数，无ARCH效应。或者从另一个角度来说就是 **历史噪声平方项 $\varepsilon_{t-i}^2$ 是白噪声**，不存在自相关。
* 备择假设$H_1$是：有ARCH效应。方程存在 $u^2_{t-i}$ 的系数 $a_i\neq 0$ ，$u_t^2$存在自相关性所以不是纯随机的，那么方差不恒定，有ARCH效应。

> 还是那个道理，我们不可能拿随机的东西来做预测。如果白噪声的平方也是白噪声，那么它的线性组合肯定也是随机的，预测不出波动率。因此，**历史噪声平方项 $\varepsilon_{t-i}^2$ 不能是白噪声。**

LM法构建的是F统计量，还是一样用口诀（数小率大选H0）判断就可以

##### BP法

全称Box-Pierce检验法，一定要注意全称避免看错！！！

根据$u^2_t\sim AR(q)$，分析 $u_t^2$ 自相关系数ACF的情况，检验m阶滞后范围内自相关是否显著。m阶是潜在可能的最大的延迟阶数，也就是ARCH模型里潜在的q的最大值。实质上就是对 $u_i^2$ 进行白噪声检验：完全无自相关的$u_t^2$肯定具有随机性，此时 $u_t^2$ 符合白噪声条件，$u_t$的方差$\sigma^2$是常数，不存在条件异方差。
$$
Q_{BP}=n\sum_{k=1}^{m}\hat{\rho_k}^2
$$
整个平稳序列所有自相关系数等于0、完全无自相关性的这种假设的可能性足够大，满足临界值的卡方分布  $\chi^2_\alpha(m)$ 时，就有足够强的理由不拒绝原假设H0“认为完全无自相关”， $u_i^2$ 时白噪声，此时 $u_i$ 不存在条件异方差。

* ==$H_0$： $u_t^2$ 在m阶内均无自相关，此时 $u_t^2$ 满足白噪声的所有假定， $u_t^2$ 是白噪声；==
* ==$H_1$： $u_t^2$ m阶内不是完全无自相关，因此 $u_t^2$ 不是白噪声。==

优点在于：大样本时效果很好 （$n>30$ 就是大样本，有研究说n在500这个量级统计检验效果较好）

不足在于：小样本时不太精确。

##### LB法
> **不存在自相关** 等价于 **有随机性，不是白噪声** 进而可以推知 **无条件异方差性**

从 $\sigma^2$ 不是白噪声这个角度出发，ARCH效应判断等价于进行$\sigma^2$的白噪声判断，因此可以选用BP法、LB法。

$$
Q_{LB}=n(n+2)\sum_{k=1}^{m} \frac{\hat{\rho_k}^2}{n-k}
$$

LB检验是BP检验的改进，现在小样本也精确了：

* ==$H_0$： $u_t^2$ 在m阶内均无自相关，此时 $u_t^2$ 满足白噪声的所有假定， $u_t^2$ 是白噪声；==
* ==$H_1$： $u_t^2$ m阶内不是完全无自相关，因此 $u_t^2$ 不是白噪声。==


### GARCH

在ARCH模型的基础上，假如我们认为波动率不止受白噪声的平方滞后项影响，还受到波动率的滞后项影响，那么就可以建立garch（广义自回归异方差）模型，其实就是arch的扩展形式Generalized ARCH，或者说arch是广义arch的一种特殊情况，最大的特点都是存在条件异方差性。所以可以用检测ARCH效应的方法，拓展到GARCH模型上。

* LM：检验原模型是否显著，也可以拆分开，分别检验ARCH项和GARCH项是否显著，计算偏自相关系数，得到模型拟合优度，得出Q统计量。
* BP、LB：计算利用 $u_i^2$ 和$\sigma^2_t$ 的自相关系数，得出Q统计量。

> **说明**
> GAECH的特点是：可以认为是ARMA在波动率 $\sigma^2_t$ 上的应用。从过程推导，首先是 $u_t^2\sim AR(p)$ 得到ARCH项，然后$\sigma_t^2\sim AR(p)$ 得到GARCH项，按照ARMA的思想进行组合，就可以得到
> $$\sigma^2_t = \alpha_0 + \sum_{i=1}^q \alpha_i u_{t-i}^2 + \sum _{j=1}^p b_j \sigma^2_{t-j} $$
>
> 所以先前在介绍ARCH模型，尽管 $u_i^2$ 存在自相关，我们却把参数写成q，就是因为在GARCH中，ARCH部分实际上类似于ARMA的移动平均部分，GARCH项类似于自回归部分。

这样就做出了在有GARCH效应下波动率的准确的估计，进而提高预测序列值的精度。

在基础的GARCH上，还有其他衍生GARCH模型。


## 后续步骤
至此我们就完成了对模型的识别。接下来就是和计量经济学一样，展开参数估计、模型检验、模型优化、模型预测。


时间序列数据要重点结合实际，特别是要结合软件比如eviews、Stata的使用。


## 附录

|    阶数    | 公式                                                              | 名称  | 意义                                             |  标准正态分布对应值   |
| :--------: | ----------------------------------------------------------------- | :---: | ------------------------------------------------ | :-------------------: |
| 一阶中心矩 | $\mu=\cfrac{1}{n}\sum_{i=1}^{n}(\frac{X_i-\mu}{\sigma})$          | 均值  | 说明数据分布的中心位置                           |           0           |
| 二阶中心矩 | $\sigma^2=\cfrac{1}{n}\sum_{i=1}^{n}[(\frac{X_i-\mu}{\sigma})^2]$ | 方差  | 描述数据的变化程度                               |           1           |
| 三阶中心矩 | $S=\cfrac{1}{n}\sum_{i=1}^{n}[(\frac{X_i-\mu}{\sigma})^3]$        | 偏度  | 描述数据对称程度，大于零为右偏                   |           0           |
| 四阶中心矩 | $K=\cfrac{1}{n}\sum_{i=1}^{n}[(\frac{X_i-\mu}{\sigma})^4]$        | 峰度  | 描述数据尾部厚度，峰度大于3或超额峰度大于0为厚尾 | 3,$超额峰度=K(x)-3=0$ |



## 应用举例

有几篇写得较好，放在此处参考。

[波动性GARCH模型与波动率预测（代码+结果分析）_garch模型怎么看预测结果-CSDN博客](https://blog.csdn.net/celiaweiwei/article/details/133860867#:~:text=ARCH 模型是用于描述时间序列数据中异方差性（方差不恒定）的一种模型。 “ARCH”,代表 “Autoregressive Conditional Heteroskedasticity”，它的基本思想是将过去的误差项的平方作为当前时间点的方差模型的输入。)

下面只进行一些简单操作。

## EXCEL简单分析

<img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312221355668.png" alt="image-20231222135535529" style="zoom:50%;" />

收集茅台近100个交易日的股价数据，在excel中简单计算并绘制相关图表。

<img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312221359044.png" style="zoom:50%;" />

我们这里所使用的时间序列分析，是针对平稳序列展开的，最希望的理想状态就是被解释变量是一条水平线，也就是解释变量线性的组合是一条水平线，这个部分完全不变动。对于可能存在的波动，则用随机误差项来表示，所以相当于用一个确定的部分加上一个波动的部分，来模拟真实的情况。这个波动的部分，就是残差，所以数据所有和波动有关的研究，都是针对残差展开的。时间序列的分析，实际上就是把被解释变量分解为确定部分+随机波动部分，假如波动部分不随机，可以继续分解，直到得到完全随机的波动部分，这样就可以做出准确的预测。

生活中我们通常理解的平稳，例如一个稳定上升的数据，实际上不同于计量经济学里的平稳性，因为其均值是在变化的。实际上平稳的是这个上升序列的趋势，类似于物理中匀加速直线运动，平稳的不是速度，而是加速度。所以，对于均匀变化的序列，我们可以研究其变化的趋势，方法是计算变化率，在实际的运用里是用取对数差分的方法来近似的。

收集了81天茅台的日收盘价数据，直接绘图如图一。图二是对日收盘价取对数的结果，可以看到数据取对数后，整体范围区间缩小，异方差性减小。但是这个序列，仍然不接近我们希望看到的水平线，所以进行差分，得到收益率（数学上结果近似），可以看到“对数差分”这个序列就比较接近我们希望看到的样子了。针对研究其波动部分也就是残差的情况，绘制残差的分布，可以看到残差近似服从正态分布，残差序列自身也接近我们希望看到的样子。当然，我们仍然可以认为残差还可以有待改进，继续把残差分解为确定部分+波动部分进行预测。

### MATLAb金融时间序列数据工具箱

在MATLAB中，可以实现很多的时间序列分析。

将数据导入进去，对原数据进行一阶差分、二阶差分、三阶差分，可以直观发现数据变得越来越平稳了。但是，并非越差分越好，多次差分之后数据很有可能反而近似于白噪声，难以找到规律进行预测。因此实际应用需要具体情况具体分析。

![](https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312221947362.webp)

---

```matlab
logdata = log(data)
autocorr(logdata, 30)
parcorr(logdata, 30)
```

遵循分析思路，首先识别数据的自相关类型。分别对原数据和对数数据、对数差分数据进行分析，计算其自相关系数、偏自相关系数，得到。

<center class="half">
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312242346803.webp" width="200"/>
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312242346831.webp" width="200"/>
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312242350930.webp" width="200"/>
</center>


<center class="half">
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312242347995.webp" width="200"/>
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312242347201.webp" width="200"/>
    <img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312242353483.webp" width="200"/>
</center>




观察发现，原数据和对数数据ACF是8阶拖尾,PACF是1阶截尾，对数差分。

```matlab
ar(logdata, 2)
```

### 白噪声

```matlab
## 生成服从标准正态分布的白噪声
y=randn(1,10000); 
 subplot(2,1,1);plot(y); 
 set(gca,'FontSize',20);
title('服从高斯分布的随机序列信号'); 
 subplot (2,1,2);hist(y,50); 
 set(gca,'FontSize',20);
title('服从高斯分布的随机序列直方图');
```

生成服从0均值方差为5的正态分布的白噪声（此处我使用MATLAB），可以看到其序列图、分布图如下。

<img src="https://prong-1316442664.cos.ap-nanjing.myqcloud.com/picgo/202312230018825.webp" alt="image-20231223001823540" style="zoom:50%;" />A
